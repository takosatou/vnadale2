(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5457:(t,e,i)=>{Promise.resolve().then(i.bind(i,1674))},1758:(t,e)=>{"use strict";var i=function(){var t=new Date,e=4;return{setLogLevel:function(t){e=t==this.debug?1:t==this.info?2:t==this.warn?3:(this.error,4)},debug:function(s,r){void 0===console.debug&&(console.debug=console.log),e<=1&&console.debug("["+i.getDurationString(new Date-t,1e3)+"]","["+s+"]",r)},log:function(t,e){this.debug(t.msg)},info:function(s,r){e<=2&&console.info("["+i.getDurationString(new Date-t,1e3)+"]","["+s+"]",r)},warn:function(s,r){e<=3&&console.warn("["+i.getDurationString(new Date-t,1e3)+"]","["+s+"]",r)},error:function(s,r){e<=4&&console.error("["+i.getDurationString(new Date-t,1e3)+"]","["+s+"]",r)}}}();i.getDurationString=function(t,e){function i(t,e){for(var i=(""+t).split(".");i[0].length<e;)i[0]="0"+i[0];return i.join(".")}t<0?(s=!0,t=-t):s=!1;var s,r=t/(e||1),n=Math.floor(r/3600);return r-=3600*n,t=Math.floor(r/60),e=Math.floor(e=1e3*(r-=60*t)-1e3*(r=Math.floor(r))),(s?"-":"")+n+":"+i(t,2)+":"+i(r,2)+"."+i(e,3)},i.printRanges=function(t){var e=t.length;if(0<e){for(var s="",r=0;r<e;r++)0<r&&(s+=","),s+="["+i.getDurationString(t.start(r))+","+i.getDurationString(t.end(r))+"]";return s}return"(empty)"},e.Log=i;var s=function(t){if(!(t instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=t,this.dataview=new DataView(t),this.position=0};s.prototype.getPosition=function(){return this.position},s.prototype.getEndPosition=function(){return this.buffer.byteLength},s.prototype.getLength=function(){return this.buffer.byteLength},s.prototype.seek=function(t){return t=Math.max(0,Math.min(this.buffer.byteLength,t)),this.position=isNaN(t)||!isFinite(t)?0:t,!0},s.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},s.prototype.readAnyInt=function(t,e){var i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:i=e?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:i=e?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";i=this.dataview.getUint8(this.position)<<16|this.dataview.getUint8(this.position+1)<<8|this.dataview.getUint8(this.position+2);break;case 4:i=e?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";i=this.dataview.getUint32(this.position)<<32|this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,i}throw"Not enough bytes in buffer"},s.prototype.readUint8=function(){return this.readAnyInt(1,!1)},s.prototype.readUint16=function(){return this.readAnyInt(2,!1)},s.prototype.readUint24=function(){return this.readAnyInt(3,!1)},s.prototype.readUint32=function(){return this.readAnyInt(4,!1)},s.prototype.readUint64=function(){return this.readAnyInt(8,!1)},s.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}throw"Not enough bytes in buffer"},s.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(0===e)break;t.push(e)}return String.fromCharCode.apply(null,t)},s.prototype.readInt8=function(){return this.readAnyInt(1,!0)},s.prototype.readInt16=function(){return this.readAnyInt(2,!0)},s.prototype.readInt32=function(){return this.readAnyInt(4,!0)},s.prototype.readInt64=function(){return this.readAnyInt(8,!1)},s.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),i=0;i<t;i++)e[i]=this.readUint8();return e},s.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readInt16();return e},s.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readUint16();return e},s.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUint32();return e},s.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),i=0;i<t;i++)e[i]=this.readInt32();return e},e.MP4BoxStream=s;var r=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=null==i?r.LITTLE_ENDIAN:i};r.prototype={},r.prototype.getPosition=function(){return this.position},r.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i)e>this._byteLength&&(this._byteLength=e);else{for(i<1&&(i=1);i<e;)i*=2;var s=new ArrayBuffer(i),t=new Uint8Array(this._buffer);new Uint8Array(s,0,t.length).set(t),this.buffer=s,this._byteLength=e}}},r.prototype._trimAlloc=function(){var t,e,i;this._byteLength!=this._buffer.byteLength&&(e=new Uint8Array(t=new ArrayBuffer(this._byteLength)),i=new Uint8Array(this._buffer,0,e.length),e.set(i),this.buffer=t)},r.BIG_ENDIAN=!1,r.LITTLE_ENDIAN=!0,r.prototype._byteLength=0,Object.defineProperty(r.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(r.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(r.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(r.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),r.prototype.seek=function(t){t=Math.max(0,Math.min(this.byteLength,t)),this.position=isNaN(t)||!isFinite(t)?0:t},r.prototype.isEof=function(){return this.position>=this._byteLength},r.prototype.mapUint8Array=function(t){this._realloc(+t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=+t,e},r.prototype.readInt32Array=function(t,e){var i=new Int32Array(t=null==t?this.byteLength-this.position/4:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readInt16Array=function(t,e){var i=new Int16Array(t=null==t?this.byteLength-this.position/2:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readInt8Array=function(t){var e=new Int8Array(t=null==t?this.byteLength-this.position:t);return r.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},r.prototype.readUint32Array=function(t,e){var i=new Uint32Array(t=null==t?this.byteLength-this.position/4:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readUint16Array=function(t,e){var i=new Uint16Array(t=null==t?this.byteLength-this.position/2:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readUint8Array=function(t){var e=new Uint8Array(t=null==t?this.byteLength-this.position:t);return r.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},r.prototype.readFloat64Array=function(t,e){var i=new Float64Array(t=null==t?this.byteLength-this.position/8:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readFloat32Array=function(t,e){var i=new Float32Array(t=null==t?this.byteLength-this.position/4:t);return r.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),r.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},r.prototype.readInt32=function(t){return t=this._dataView.getInt32(this.position,null==t?this.endianness:t),this.position+=4,t},r.prototype.readInt16=function(t){return t=this._dataView.getInt16(this.position,null==t?this.endianness:t),this.position+=2,t},r.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},r.prototype.readUint32=function(t){return t=this._dataView.getUint32(this.position,null==t?this.endianness:t),this.position+=4,t},r.prototype.readUint16=function(t){return t=this._dataView.getUint16(this.position,null==t?this.endianness:t),this.position+=2,t},r.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},r.prototype.readFloat32=function(t){return t=this._dataView.getFloat32(this.position,null==t?this.endianness:t),this.position+=4,t},r.prototype.readFloat64=function(t){return t=this._dataView.getFloat64(this.position,null==t?this.endianness:t),this.position+=8,t},r.endianness=0<new Int8Array(new Int16Array([1]).buffer)[0],r.memcpy=function(t,e,i,s,r){e=new Uint8Array(t,e,r),r=new Uint8Array(i,s,r),e.set(r)},r.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},r.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},r.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var s=i+t.BYTES_PER_ELEMENT-1,r=i;r<s;s--,r++){var n=e[r];e[r]=e[s],e[s]=n}return t},r.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},r.prototype.readString=function(t,e){return null==e||"ASCII"==e?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==t?this.byteLength-this.position:t)]):new TextDecoder(e).decode(this.mapUint8Array(t))},r.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;null!=t&&(s=Math.min(t,e));for(var r=0;r<s&&0!==i[r];r++);var n=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(r)]);return null!=t?this.position+=s-r:r!=e&&(this.position+=1),n},r.prototype.readInt64=function(){return 0x100000000*this.readInt32()+this.readUint32()},r.prototype.readUint64=function(){return 0x100000000*this.readUint32()+this.readUint32()},r.prototype.readInt64=function(){return 0x100000000*this.readUint32()+this.readUint32()},r.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},e.DataStream=r,r.prototype.save=function(t){var e=new Blob([this.buffer]);if(!window.URL||!URL.createObjectURL)throw"DataStream.save: Can't create object URL.";var i=window.URL.createObjectURL(e),e=document.createElement("a");document.body.appendChild(e),e.setAttribute("href",i),e.setAttribute("download",t),e.setAttribute("target","_self"),e.click(),window.URL.revokeObjectURL(i)},r.prototype._dynamicSize=!0,Object.defineProperty(r.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),r.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),s=new Uint8Array(this._buffer,t,i.length);i.set(s),this.buffer=e,this.position-=t},r.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},r.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},r.prototype.writeInt8Array=function(t){if(this._realloc(+t.length),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},r.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},r.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},r.prototype.writeUint8Array=function(t){if(this._realloc(+t.length),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},r.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},r.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)r.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},r.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},r.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},r.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},r.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},r.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},r.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},r.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},r.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},r.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var s=0;s<t.length&&s<i;s++)this.writeUint16(t.charCodeAt(s),e);for(;s<i;s++)this.writeUint16(0)},r.prototype.writeString=function(t,e,i){var s=0;if(null==e||"ASCII"==e){if(null!=i){for(var r=Math.min(t.length,i),s=0;s<r;s++)this.writeUint8(t.charCodeAt(s));for(;s<i;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s))}else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},r.prototype.writeCString=function(t,e){var i=0;if(null!=e){for(var s=Math.min(t.length,e),i=0;i<s;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},r.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var s=t[i+1];this.writeType(s,e[t[i]],e)}},r.prototype.writeType=function(t,e,i){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var s,n=null,a="ASCII",i=this.position;switch("string"==typeof t&&/:/.test(t)&&(t=(s=t.split(":"))[0],n=parseInt(s[1])),"string"==typeof t&&/,/.test(t)&&(t=(s=t.split(","))[0],a=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,r.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,r.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,r.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,r.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,r.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,r.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,r.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,r.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,r.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,r.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,r.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,r.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,n);break;case"string":this.writeString(e,a,n);break;case"u16string":this.writeUCS2String(e,this.endianness,n);break;case"u16stringle":this.writeUCS2String(e,r.LITTLE_ENDIAN,n);break;case"u16stringbe":this.writeUCS2String(e,r.BIG_ENDIAN,n);break;default:if(3==t.length){for(var o=t[1],h=0;h<e.length;h++)this.writeType(o,e[h]);break}this.writeStruct(t,e)}null!=n&&(this.position=i,this._realloc(n),this.position=i+n)},r.prototype.writeUint64=function(t){var e=Math.floor(t/0x100000000);this.writeUint32(e),this.writeUint32(0xffffffff&t)},r.prototype.writeUint24=function(t){this.writeUint8((0xff0000&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)},r.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},r.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},r.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},r.prototype.mapInt8Array=function(t){this._realloc(+t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=+t,e},r.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},r.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},r.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},r.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return r.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i};var n=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};n.prototype=new r(new ArrayBuffer,0,r.BIG_ENDIAN),n.prototype.initialized=function(){var t;return -1<this.bufferIndex||(0<this.buffers.length?0===(t=this.buffers[0]).fileStart?(this.buffer=t,this.bufferIndex=0,i.debug("MultiBufferStream","Stream ready for parsing"),!0):(i.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1):(i.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(t,e){i.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var s=new Uint8Array(t.byteLength+e.byteLength);return s.set(new Uint8Array(t),0),s.set(new Uint8Array(e),t.byteLength),s.buffer},n.prototype.reduceBuffer=function(t,e,i){var s=new Uint8Array(i);return s.set(new Uint8Array(t,e,i)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer},n.prototype.insertBuffer=function(t){for(var e=!0,s=0;s<this.buffers.length;s++){var r=this.buffers[s];if(t.fileStart<=r.fileStart){if(t.fileStart===r.fileStart){if(t.byteLength>r.byteLength){this.buffers.splice(s,1),s--;continue}i.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=r.fileStart||(t=this.reduceBuffer(t,0,r.fileStart-t.fileStart)),i.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(s,0,t),0===s&&(this.buffer=t);e=!1;break}if(t.fileStart<r.fileStart+r.byteLength){var n=r.fileStart+r.byteLength-t.fileStart,r=t.byteLength-n;if(!(0<r)){e=!1;break}t=this.reduceBuffer(t,n,r)}}e&&(i.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===s&&(this.buffer=t))},n.prototype.logBufferLevel=function(t){for(var e,s,r=[],n="",a=0,o=0,h=0;h<this.buffers.length;h++)e=this.buffers[h],0===h?(r.push(s={}),s.start=e.fileStart,s.end=e.fileStart+e.byteLength,n+="["+s.start+"-"):s.end===e.fileStart?s.end=e.fileStart+e.byteLength:((s={}).start=e.fileStart,n+=r[r.length-1].end-1+"], ["+s.start+"-",s.end=e.fileStart+e.byteLength,r.push(s)),a+=e.usedBytes,o+=e.byteLength;0<r.length&&(n+=s.end-1+"]"),(t=t?i.info:i.debug)("MultiBufferStream",0===this.buffers.length?"No more buffer in memory":this.buffers.length+" stored buffer(s) ("+a+"/"+o+" bytes), continuous ranges: "+n)},n.prototype.cleanBuffers=function(){for(var t,e=0;e<this.buffers.length;e++)(t=this.buffers[e]).usedBytes===t.byteLength&&(i.debug("MultiBufferStream","Removing buffer #"+e),this.buffers.splice(e,1),e--)},n.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length){if((t=this.buffers[this.bufferIndex+1]).fileStart!==this.buffer.fileStart+this.buffer.byteLength)return!1;var e=this.buffer.byteLength,s=this.buffer.usedBytes,r=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=s,this.buffer.fileStart=r,i.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}return!1},n.prototype.findPosition=function(t,e,s){for(var r=null,n=-1,a=!0===t?0:this.bufferIndex;a<this.buffers.length&&(r=this.buffers[a]).fileStart<=e;)n=a,s&&(r.fileStart+r.byteLength<=e?r.usedBytes=r.byteLength:r.usedBytes=e-r.fileStart,this.logBufferLevel()),a++;return -1!==n&&(r=this.buffers[n]).fileStart+r.byteLength>=e?(i.debug("MultiBufferStream","Found position in existing buffer #"+n),n):-1},n.prototype.findEndContiguousBuf=function(t){var e,i,t=void 0!==t?t:this.bufferIndex,s=this.buffers[t];if(this.buffers.length>t+1)for(e=t+1;e<this.buffers.length&&(i=this.buffers[e]).fileStart===s.fileStart+s.byteLength;e++)s=i;return s.fileStart+s.byteLength},n.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return -1!==e?this.findEndContiguousBuf(e):t},n.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},n.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},n.prototype.seek=function(t,e,s){return -1!==(s=this.findPosition(e,t,s))?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,i.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(i.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},n.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},n.prototype.getLength=function(){return this.byteLength},n.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},e.MultiBufferStream=n;var a=function(){var t=[];t[3]="ES_Descriptor",t[4]="DecoderConfigDescriptor",t[5]="DecoderSpecificInfo",t[6]="SLConfigDescriptor",this.getDescriptorName=function(e){return t[e]};var e=this,s={};return this.parseOneDescriptor=function(e){var r,n=0,a=e.readUint8();for(r=e.readUint8();128&r;)n=(127&r)<<7,r=e.readUint8();return n+=127&r,i.debug("MPEG4DescriptorParser","Found "+(t[a]||"Descriptor "+a)+", size "+n+" at position "+e.getPosition()),(a=new(t[a]?s[t[a]]:s.Descriptor)(n)).parse(e),a},s.Descriptor=function(t,e){this.tag=t,this.size=e,this.descs=[]},s.Descriptor.prototype.parse=function(t){this.data=t.readUint8Array(this.size)},s.Descriptor.prototype.findDescriptor=function(t){for(var e=0;e<this.descs.length;e++)if(this.descs[e].tag==t)return this.descs[e];return null},s.Descriptor.prototype.parseRemainingDescriptors=function(t){for(var i=t.position;t.position<i+this.size;){var s=e.parseOneDescriptor(t);this.descs.push(s)}},s.ES_Descriptor=function(t){s.Descriptor.call(this,3,t)},s.ES_Descriptor.prototype=new s.Descriptor,s.ES_Descriptor.prototype.parse=function(t){var e;this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags?(e=t.readUint8(),this.URL=t.readString(e),this.size-=e+1):this.URL="",32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)},s.ES_Descriptor.prototype.getOTI=function(t){var e=this.findDescriptor(4);return e?e.oti:0},s.ES_Descriptor.prototype.getAudioConfig=function(t){var e=this.findDescriptor(4);if(!e)return null;var i=e.findDescriptor(5);return i&&i.data?(31==(e=(248&i.data[0])>>3)&&2<=i.data.length&&(e=32+((7&i.data[0])<<3)+((224&i.data[1])>>5)),e):null},s.DecoderConfigDescriptor=function(t){s.Descriptor.call(this,4,t)},s.DecoderConfigDescriptor.prototype=new s.Descriptor,s.DecoderConfigDescriptor.prototype.parse=function(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)},s.DecoderSpecificInfo=function(t){s.Descriptor.call(this,5,t)},s.DecoderSpecificInfo.prototype=new s.Descriptor,s.SLConfigDescriptor=function(t){s.Descriptor.call(this,6,t)},s.SLConfigDescriptor.prototype=new s.Descriptor,this};e.MPEG4DescriptorParser=a;var o={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){o.FullBox.prototype=new o.Box,o.ContainerBox.prototype=new o.Box,o.SampleEntry.prototype=new o.Box,o.TrackGroupTypeBox.prototype=new o.FullBox,o.BASIC_BOXES.forEach(function(t){o.createBoxCtor(t)}),o.FULL_BOXES.forEach(function(t){o.createFullBoxCtor(t)}),o.CONTAINER_BOXES.forEach(function(t){o.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,i){this.type=t,this.size=e,this.uuid=i},FullBox:function(t,e,i){o.Box.call(this,t,e,i),this.flags=0,this.version=0},ContainerBox:function(t,e,i){o.Box.call(this,t,e,i),this.boxes=[]},SampleEntry:function(t,e,i,s){o.ContainerBox.call(this,t,e),this.hdr_size=i,this.start=s},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){o.FullBox.call(this,t,e)},createBoxCtor:function(t,e){o.boxCodes.push(t),o[t+"Box"]=function(e){o.Box.call(this,t,e)},o[t+"Box"].prototype=new o.Box,e&&(o[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){o[t+"Box"]=function(e){o.FullBox.call(this,t,e)},o[t+"Box"].prototype=new o.FullBox,o[t+"Box"].prototype.parse=function(t){this.parseFullHeader(t),e&&e.call(this,t)}},addSubBoxArrays:function(t){if(t)for(var e=(this.subBoxNames=t).length,i=0;i<e;i++)this[t[i]+"s"]=[]},createContainerBoxCtor:function(t,e,i){o[t+"Box"]=function(e){o.ContainerBox.call(this,t,e),o.addSubBoxArrays.call(this,i)},o[t+"Box"].prototype=new o.ContainerBox,e&&(o[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,i){o.sampleEntryCodes[t]=[],o[t+"SampleEntry"]=function(t,e){o.SampleEntry.call(this,t,e),o.addSubBoxArrays.call(this,i)},o[t+"SampleEntry"].prototype=new o.SampleEntry,e&&(o[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,i,s){o.sampleEntryCodes[t].push(e),o[e+"SampleEntry"]=function(i){o[t+"SampleEntry"].call(this,e,i),o.addSubBoxArrays.call(this,s)},o[e+"SampleEntry"].prototype=new o[t+"SampleEntry"],i&&(o[e+"SampleEntry"].prototype.parse=i)},createEncryptedSampleEntryCtor:function(t,e,i){o.createSampleEntryCtor.call(this,t,e,i,["sinf"])},createSampleGroupCtor:function(t,e){o[t+"SampleGroupEntry"]=function(e){o.SampleGroupEntry.call(this,t,e)},o[t+"SampleGroupEntry"].prototype=new o.SampleGroupEntry,e&&(o[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){o[t+"TrackGroupTypeBox"]=function(e){o.TrackGroupTypeBox.call(this,t,e)},o[t+"TrackGroupTypeBox"].prototype=new o.TrackGroupTypeBox,e&&(o[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,i,s){o.UUIDs.push(t),o.UUIDBoxes[t]=function(s){(e?o.FullBox:i?o.ContainerBox:o.Box).call(this,"uuid",s,t)},o.UUIDBoxes[t].prototype=new(e?o.FullBox:i?o.ContainerBox:o.Box),s&&(o.UUIDBoxes[t].prototype.parse=e?function(t){this.parseFullHeader(t),s&&s.call(this,t)}:s)}};o.initialize(),o.TKHD_FLAG_ENABLED=1,o.TKHD_FLAG_IN_MOVIE=2,o.TKHD_FLAG_IN_PREVIEW=4,o.TFHD_FLAG_BASE_DATA_OFFSET=1,o.TFHD_FLAG_SAMPLE_DESC=2,o.TFHD_FLAG_SAMPLE_DUR=8,o.TFHD_FLAG_SAMPLE_SIZE=16,o.TFHD_FLAG_SAMPLE_FLAGS=32,o.TFHD_FLAG_DUR_EMPTY=65536,o.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,o.TRUN_FLAGS_DATA_OFFSET=1,o.TRUN_FLAGS_FIRST_FLAG=4,o.TRUN_FLAGS_DURATION=256,o.TRUN_FLAGS_SIZE=512,o.TRUN_FLAGS_FLAGS=1024,o.TRUN_FLAGS_CTS_OFFSET=2048,o.Box.prototype.add=function(t){return this.addBox(new o[t+"Box"])},o.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},o.Box.prototype.set=function(t,e){return this[t]=e,this},o.Box.prototype.addEntry=function(t,e){return this[e=e||"entries"]||(this[e]=[]),this[e].push(t),this},e.BoxParser=o,o.parseUUID=function(t){return o.parseHex16(t)},o.parseHex16=function(t){for(var e="",i=0;i<16;i++){var s=t.readUint8().toString(16);e+=1===s.length?"0"+s:s}return e},o.parseOneBox=function(t,e,s){var r,n,a=t.getPosition(),h=0;if(t.getEndPosition()-a<8)return i.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:o.ERR_NOT_ENOUGH_DATA};if(s&&s<8)return i.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:o.ERR_NOT_ENOUGH_DATA};var l=t.readUint32(),d=t.readString(4),p=d;if(i.debug("BoxParser","Found box of type '"+d+"' and size "+l+" at position "+a),h=8,"uuid"==d){if(t.getEndPosition()-t.getPosition()<16||s-h<16)return t.seek(a),i.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:o.ERR_NOT_ENOUGH_DATA};h+=16,p=n=o.parseUUID(t)}if(1==l){if(t.getEndPosition()-t.getPosition()<8||s&&s-h<8)return t.seek(a),i.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:o.ERR_NOT_ENOUGH_DATA};l=t.readUint64(),h+=8}else if(0===l){if(s)l=s;else if("mdat"!==d)return i.error("BoxParser","Unlimited box size not supported for type: '"+d+"'"),r=new o.Box(d,l),{code:o.OK,box:r,size:r.size}}return 0!==l&&l<h?(i.error("BoxParser","Box of type "+d+" has an invalid size "+l+" (too small to be a box)"),{code:o.ERR_NOT_ENOUGH_DATA,type:d,size:l,hdr_size:h,start:a}):0!==l&&s&&s<l?(i.error("BoxParser","Box of type '"+d+"' has a size "+l+" greater than its container size "+s),{code:o.ERR_NOT_ENOUGH_DATA,type:d,size:l,hdr_size:h,start:a}):0!==l&&a+l>t.getEndPosition()?(t.seek(a),i.info("BoxParser","Not enough data in stream to parse the entire '"+d+"' box"),{code:o.ERR_NOT_ENOUGH_DATA,type:d,size:l,hdr_size:h,start:a}):e?{code:o.OK,type:d,size:l,hdr_size:h,start:a}:(o[d+"Box"]?r=new o[d+"Box"](l):"uuid"!==d?(i.warn("BoxParser","Unknown box type: '"+d+"'"),(r=new o.Box(d,l)).has_unparsed_data=!0):o.UUIDBoxes[n]?r=new o.UUIDBoxes[n](l):(i.warn("BoxParser","Unknown uuid type: '"+n+"'"),(r=new o.Box(d,l)).uuid=n,r.has_unparsed_data=!0),r.hdr_size=h,r.start=a,r.write===o.Box.prototype.write&&"mdat"!==r.type&&(i.info("BoxParser","'"+p+"' box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),(a=t.getPosition()-(r.start+r.size))<0?(i.warn("BoxParser","Parsing of box '"+p+"' did not read the entire indicated box data size (missing "+-a+" bytes), seeking forward"),t.seek(r.start+r.size)):0<a&&(i.error("BoxParser","Parsing of box '"+p+"' read "+a+" more bytes than the indicated box data size, seeking backwards"),0!==r.size&&t.seek(r.start+r.size)),{code:o.OK,box:r,size:r.size})},o.Box.prototype.parse=function(t){"mdat"!=this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},o.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},o.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},o.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},o.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},o.ContainerBox.prototype.parse=function(t){for(;t.getPosition()<this.start+this.size;){if((e=o.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==o.OK)return;var e,s=e.box;this.boxes.push(s),this.subBoxNames&&-1!=this.subBoxNames.indexOf(s.type)?this[this.subBoxNames[this.subBoxNames.indexOf(s.type)]+"s"].push(s):this[e="uuid"!==s.type?s.type:s.uuid]?i.warn("Box of type "+e+" already stored in field of this type"):this[e]=s}},o.Box.prototype.parseLanguage=function(t){this.language=t.readUint16(),(t=[])[0]=this.language>>10&31,t[1]=this.language>>5&31,t[2]=31&this.language,this.languageString=String.fromCharCode(t[0]+96,t[1]+96,t[2]+96)},o.SAMPLE_ENTRY_TYPE_VISUAL="Visual",o.SAMPLE_ENTRY_TYPE_AUDIO="Audio",o.SAMPLE_ENTRY_TYPE_HINT="Hint",o.SAMPLE_ENTRY_TYPE_METADATA="Metadata",o.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",o.SAMPLE_ENTRY_TYPE_SYSTEM="System",o.SAMPLE_ENTRY_TYPE_TEXT="Text",o.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},o.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},o.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},o.SampleEntry.prototype.parseFooter=function(t){o.ContainerBox.prototype.parse.call(this,t)},o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_HINT),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_METADATA),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SYSTEM),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_TEXT),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),o.createMediaSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_TEXT,"enct"),o.createEncryptedSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_METADATA,"encm"),o.createBoxCtor("a1lx",function(t){var e=16*(1+(1&(1&t.readUint8())));this.layer_size=[];for(var i=0;i<3;i++)this.layer_size[i]=16==e?t.readUint16():t.readUint32()}),o.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),o.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),o.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1)i.error("av1C marker problem");else if(this.version=127&e,1===this.version){if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=31&e,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=3&e,e=t.readUint8(),this.reserved_1=e>>5&7,0===this.reserved_1){if(this.initial_presentation_delay_present=e>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&e;else if(this.reserved_2=15&e,0!==this.reserved_2)return void i.error("av1C reserved_2 parsing problem");e=this.size-this.hdr_size-4,this.configOBUs=t.readUint8Array(e)}else i.error("av1C reserved_1 parsing problem")}else i.error("av1C version "+this.version+" not supported")}),o.createBoxCtor("avcC",function(t){var e,i;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),this.nb_SPS_nalus=31&t.readUint8(),i=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),i-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),i--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),i-=2+this.PPS[e].length;0<i&&(this.ext=t.readUint8Array(i))}),o.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),o.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),o.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),o.createFullBoxCtor("co64",function(t){var e,i=t.readUint32();if(this.chunk_offsets=[],0===this.version)for(e=0;e<i;e++)this.chunk_offsets.push(t.readUint64())}),o.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),o.createBoxCtor("colr",function(t){var e;this.colour_type=t.readString(4),"nclx"===this.colour_type?(this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16(),e=t.readUint8(),this.full_range_flag=e>>7):"rICC"!==this.colour_type&&"prof"!==this.colour_type||(this.ICC_profile=t.readUint8Array(this.size-4))}),o.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),o.createFullBoxCtor("cslg",function(t){0===this.version&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),o.createFullBoxCtor("ctts",function(t){var e,s=t.readUint32();if(this.sample_counts=[],this.sample_offsets=[],0===this.version)for(e=0;e<s;e++){this.sample_counts.push(t.readUint32());var r=t.readInt32();r<0&&i.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(r)}else if(1==this.version)for(e=0;e<s;e++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),o.createBoxCtor("dac3",function(t){var e=t.readUint8(),i=t.readUint8(),t=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(1&e)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=3&i|t>>5&7}),o.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=7&e,this.ind_subs=[];for(var i=0;i<this.num_ind_sub+1;i++){var s={};this.ind_subs.push(s);var r=t.readUint8(),n=t.readUint8(),a=t.readUint8();s.fscod=r>>6,s.bsid=r>>1&31,s.bsmod=(1&r)<<4|n>>4&15,s.acmod=n>>1&7,s.lfeon=1&n,s.num_dep_sub=a>>1&15,0<s.num_dep_sub&&(s.chan_loc=(1&a)<<8|t.readUint8())}}),o.createFullBoxCtor("dfLa",function(t){var e=[],i=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];for(this.parseFullHeader(t);;){var s=t.readUint8(),r=Math.min(127&s,i.length-1);if(r?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),e.push(i[r]),128&s)break}this.numMetadataBlocks=e.length+" ("+e.join(", ")+")"}),o.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),o.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),o.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),o.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),0!==this.ChannelMappingFamily){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),o.createFullBoxCtor("dref",function(t){var e;this.entries=[];for(var i=t.readUint32(),s=0;s<i;s++){if((e=o.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==o.OK)return;e=e.box,this.entries.push(e)}}),o.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),o.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),o.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),1===this.version?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}}),o.createFullBoxCtor("emsg",function(t){1==this.version?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));1==this.version&&(e-=4),this.message_data=t.readUint8Array(e)}),o.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);void 0!==a&&(t=new a,this.esd=t.parseOneDescriptor(new r(e.buffer,0,r.BIG_ENDIAN)))}),o.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),o.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),o.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;4<=e;)this.compatible_brands[i]=t.readString(4),e-=4,i++}),o.createFullBoxCtor("hdlr",function(t){0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))}),o.createBoxCtor("hvcC",function(t){var e,i;this.configurationVersion=t.readUint8(),i=t.readUint8(),this.general_profile_space=i>>6,this.general_tier_flag=(32&i)>>5,this.general_profile_idc=31&i,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chroma_format_idc=3&t.readUint8(),this.bit_depth_luma_minus8=7&t.readUint8(),this.bit_depth_chroma_minus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),i=t.readUint8(),this.constantFrameRate=i>>6,this.numTemporalLayers=(13&i)>>3,this.temporalIdNested=(4&i)>>2,this.lengthSizeMinusOne=3&i,this.nalu_arrays=[];for(var s=t.readUint8(),r=0;r<s;r++){var n=[];this.nalu_arrays.push(n),i=t.readUint8(),n.completeness=(128&i)>>7,n.nalu_type=63&i;for(var a=t.readUint16(),o=0;o<a;o++){var h={};n.push(h),e=t.readUint16(),h.data=t.readUint8Array(e)}}}),o.createFullBoxCtor("iinf",function(t){var e;0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var s=0;s<this.entry_count;s++){if((e=o.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==o.OK)return;"infe"!==e.box.type&&i.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[s]=e.box}}),o.createFullBoxCtor("iloc",function(t){var e=t.readUint8();this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";i=t.readUint32()}for(var s=0;s<i;s++){var r={};if(this.items.push(r),this.version<2)r.item_ID=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";r.item_ID=t.readUint16()}switch(1===this.version||2===this.version?r.construction_method=15&t.readUint16():r.construction_method=0,r.data_reference_index=t.readUint16(),this.base_offset_size){case 0:r.base_offset=0;break;case 4:r.base_offset=t.readUint32();break;case 8:r.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var n=t.readUint16();r.extents=[];for(var a=0;a<n;a++){var o={};if(r.extents.push(o),1===this.version||2===this.version)switch(this.index_size){case 0:o.extent_index=0;break;case 4:o.extent_index=t.readUint32();break;case 8:o.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:o.extent_offset=0;break;case 4:o.extent_offset=t.readUint32();break;case 8:o.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:o.extent_length=0;break;case 4:o.extent_length=t.readUint32();break;case 8:o.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),o.createBoxCtor("imir",function(t){t=t.readUint8(),this.reserved=t>>7,this.axis=1&t}),o.createFullBoxCtor("infe",function(t){return 0!==this.version&&1!==this.version||(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),1===this.version?(this.extension_type=t.readString(4),i.warn("BoxParser","Cannot parse extension type"),void t.seek(this.start+this.size)):void(2<=this.version&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString())))}),o.createFullBoxCtor("ipma",function(t){var e,i;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var s={};this.associations.push(s),this.version<1?s.id=t.readUint16():s.id=t.readUint32();var r=t.readUint8();for(s.props=[],i=0;i<r;i++){var n=t.readUint8(),a={};s.props.push(a),a.essential=(128&n)>>7==1,1&this.flags?a.property_index=(127&n)<<8|t.readUint8():a.property_index=127&n}}}),o.createFullBoxCtor("iref",function(t){var e;for(this.references=[];t.getPosition()<this.start+this.size;){if((e=o.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==o.OK)return;(e=new(0===this.version?o.SingleItemTypeReferenceBox:o.SingleItemTypeReferenceBoxLarge)(e.type,e.size,e.hdr_size,e.start)).write===o.Box.prototype.write&&"mdat"!==e.type&&(i.warn("BoxParser",e.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),e.parseDataAndRewind(t)),e.parse(t),this.references.push(e)}}),o.createBoxCtor("irot",function(t){this.angle=3&t.readUint8()}),o.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),o.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),o.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var s=0;s<e;s++){var r={};(this.levels[s]=r).track_ID=t.readUint32();var n=t.readUint8();switch(r.padding_flag=n>>7,r.assignment_type=127&n,r.assignment_type){case 0:r.grouping_type=t.readString(4);break;case 1:r.grouping_type=t.readString(4),r.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:r.sub_track_id=t.readUint32();break;default:i.warn("BoxParser","Unknown leva assignement type")}}}),o.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),o.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),o.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),o.createFullBoxCtor("mdhd",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),o.createFullBoxCtor("mehd",function(t){1&this.flags&&(i.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),o.createFullBoxCtor("meta",function(t){this.boxes=[],o.ContainerBox.prototype.parse.call(this,t)}),o.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),o.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),o.createFullBoxCtor("mvhd",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),o.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),o.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),o.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()}),o.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),o.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),o.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),o.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;i<e;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()}),o.createFullBoxCtor("pitm",function(t){0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()}),o.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),o.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),o.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()}),o.createFullBoxCtor("pssh",function(t){if(this.system_id=o.parseHex16(t),0<this.version){var e=t.readUint32();this.kid=[];for(var i=0;i<e;i++)this.kid[i]=o.parseHex16(t)}var s=t.readUint32();0<s&&(this.data=t.readUint8Array(s))}),o.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),o.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),o.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),o.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),o.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),o.createFullBoxCtor("saio",function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;i<e;i++)0===this.version?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()}),o.createFullBoxCtor("saiz",function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var i=0;i<e;i++)this.sample_info_size[i]=t.readUint8()}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),o.createSampleEntryCtor(o.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),o.createSampleGroupCtor("alst",function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<i;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<s/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),o.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),o.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),s=0;s<i;s++){var r={};this.dependency.push(r),r.subSeqDirectionFlag=t.readUint8(),r.layerNumber=t.readUint8(),r.subSequenceIdentifier=t.readUint16()}}),o.createSampleGroupCtor("dtrt",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("mvif",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),o.createSampleGroupCtor("rap ",function(t){t=t.readUint8(),this.num_leading_samples_known=t>>7,this.num_leading_samples=127&t}),o.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)i.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),o.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),o.SampleGroupEntry.prototype.parse=function(t){i.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},o.createSampleGroupCtor("scif",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("scnm",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=15&e,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=o.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),o.createSampleGroupCtor("stsa",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("sync",function(t){t=t.readUint8(),this.NAL_unit_type=63&t}),o.createSampleGroupCtor("tele",function(t){t=t.readUint8(),this.level_independently_decodable=t>>7}),o.createSampleGroupCtor("tsas",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("tscl",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createSampleGroupCtor("vipr",function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),o.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}}),o.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),o.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),o.createFullBoxCtor("sdtp",function(t){var e,i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;s<i;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=3&e}),o.createFullBoxCtor("senc"),o.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),i.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,2<=this.version&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var r=new(o[this.grouping_type+"SampleGroupEntry"]?o[this.grouping_type+"SampleGroupEntry"]:o.SampleGroupEntry)(this.grouping_type);this.entries.push(r),1===this.version&&0===this.default_length?r.description_length=t.readUint32():r.description_length=this.default_length,r.write===o.SampleGroupEntry.prototype.write&&(i.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),r.data=t.readUint8Array(r.description_length),t.position-=r.description_length),r.parse(t)}}),o.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;i<e;i++){var s={};this.references.push(s);var r=t.readUint32();s.reference_type=r>>31&1,s.referenced_size=0x7fffffff&r,s.subsegment_duration=t.readUint32(),r=t.readUint32(),s.starts_with_SAP=r>>31&1,s.SAP_type=r>>28&7,s.SAP_delta_time=0xfffffff&r}}),o.SingleItemTypeReferenceBox=function(t,e,i,s){o.Box.call(this,t,e),this.hdr_size=i,this.start=s},o.SingleItemTypeReferenceBox.prototype=new o.Box,o.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint16()},o.SingleItemTypeReferenceBoxLarge=function(t,e,i,s){o.Box.call(this,t,e),this.hdr_size=i,this.start=s},o.SingleItemTypeReferenceBoxLarge.prototype=new o.Box,o.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint32()},o.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),o.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),o.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),i=0;i<e;i++){var s={};this.subsegments.push(s),s.ranges=[];for(var r=t.readUint32(),n=0;n<r;n++){var a={};s.ranges.push(a),a.level=t.readUint8(),a.range_size=t.readUint24()}}}),o.createFullBoxCtor("stco",function(t){var e=t.readUint32();if(this.chunk_offsets=[],0===this.version)for(var i=0;i<e;i++)this.chunk_offsets.push(t.readUint32())}),o.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;i<e;i++)this.priority[i]=t.readUint16()}),o.createFullBoxCtor("sthd"),o.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),o.createFullBoxCtor("stsc",function(t){var e,i=t.readUint32();if(this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(e=0;e<i;e++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),o.createFullBoxCtor("stsd",function(t){var e,s,r,n;for(this.entries=[],r=t.readUint32(),e=1;e<=r;e++){if((s=o.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==o.OK)return;o[s.type+"SampleEntry"]?((n=new o[s.type+"SampleEntry"](s.size)).hdr_size=s.hdr_size,n.start=s.start):(i.warn("BoxParser","Unknown sample entry type: "+s.type),n=new o.SampleEntry(s.type,s.size,s.hdr_size,s.start)),n.write===o.SampleEntry.prototype.write&&(i.info("BoxParser","SampleEntry "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.entries.push(n)}}),o.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;i<e;i++)this.group_description_index[i]=t.readUint32()}),o.createFullBoxCtor("stsh",function(t){var e,i=t.readUint32();if(this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(e=0;e<i;e++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),o.createFullBoxCtor("stss",function(t){var e,i=t.readUint32();if(0===this.version)for(this.sample_numbers=[],e=0;e<i;e++)this.sample_numbers.push(t.readUint32())}),o.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],0===this.version)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)0===this.sample_size?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),o.createFullBoxCtor("stts",function(t){var e,s,r=t.readUint32();if(this.sample_counts=[],this.sample_deltas=[],0===this.version)for(e=0;e<r;e++)this.sample_counts.push(t.readUint32()),(s=t.readInt32())<0&&(i.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)}),o.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=3&e,this.stereo_scheme=t.readUint32();var i,e=t.readUint32();for(this.stereo_indication_type=t.readString(e),this.boxes=[];t.getPosition()<this.start+this.size;){if((i=o.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==o.OK)return;i=i.box,this.boxes.push(i),this[i.type]=i}}),o.createBoxCtor("styp",function(t){o.ftypBox.prototype.parse.call(this,t)}),o.createFullBoxCtor("stz2",function(t){var e,s;if(this.sample_sizes=[],0===this.version){if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),s=t.readUint32(),4===this.field_size)for(e=0;e<s;e+=2){var r=t.readUint8();this.sample_sizes[e]=r>>4&15,this.sample_sizes[e+1]=15&r}else if(8===this.field_size)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint8();else if(16===this.field_size)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint16();else i.error("BoxParser","Error in length field in stz2 box")}}),o.createFullBoxCtor("subs",function(t){var e,i,s,r=t.readUint32();for(this.entries=[],e=0;e<r;e++){var n={};if((this.entries[e]=n).sample_delta=t.readUint32(),n.subsamples=[],0<(s=t.readUint16()))for(i=0;i<s;i++){var a={};n.subsamples.push(a),1==this.version?a.size=t.readUint32():a.size=t.readUint16(),a.priority=t.readUint8(),a.discardable=t.readUint8(),a.codec_specific_parameters=t.readUint32()}}}),o.createFullBoxCtor("tenc",function(t){var e;t.readUint8(),0===this.version?t.readUint8():(e=t.readUint8(),this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=15&e),this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=o.parseHex16(t),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),o.createFullBoxCtor("tfdt",function(t){1==this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),o.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&o.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&o.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&o.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&o.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&o.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),o.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];for(var i=t.readUint32(),s=0;s<i;s++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),o.createFullBoxCtor("tkhd",function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),o.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),o.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),o.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),o.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),o.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),o.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},o.createTrackGroupCtor("msrc"),o.TrackReferenceTypeBox=function(t,e,i,s){o.Box.call(this,t,e),this.hdr_size=i,this.start=s},o.TrackReferenceTypeBox.prototype=new o.Box,o.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},o.trefBox.prototype.parse=function(t){for(var e;t.getPosition()<this.start+this.size;){if((e=o.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==o.OK)return;(e=new o.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start)).write===o.Box.prototype.write&&"mdat"!==e.type&&(i.info("BoxParser","TrackReference "+e.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),e.parseDataAndRewind(t)),e.parse(t),this.boxes.push(e)}},o.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){if((ret=o.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==o.OK)return;box=ret.box,this.boxes.push(box)}}),o.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),o.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),o.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&o.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&o.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&o.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&o.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&o.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&o.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())}),o.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()}),o.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),o.createFullBoxCtor("url ",function(t){1!==this.flags&&(this.location=t.readCString())}),o.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),0<this.size-this.hdr_size-this.name.length-1&&(this.location=t.readCString())}),o.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),o.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=o.parseHex16(t);var e=t.readUint32();0<e&&(this.data=t.readUint8Array(e))}),o.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),o.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=o.parseHex16(t)}),o.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var i={},s=0,r=1===this.version?(s=t.readUint64(),t.readUint64()):(s=t.readUint32(),t.readUint32());i.absolute_time=s,i.absolute_duration=r,this.entries.push(i)}}),o.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){1===this.version?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),o.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),o.createFullBoxCtor("vpcC",function(t){var e;1===this.version?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=1&e,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8()):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=15&e,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=1&e),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)}),o.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),o.createFullBoxCtor("vvcC",function(t){var e,i={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(t){this.held_bits=t.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(t){this.held_bits=t.readUint16(),this.num_held_bits=16},extract_bits:function(t){var e=this.held_bits>>this.num_held_bits-t&(1<<t)-1;return this.num_held_bits-=t,e}};if(i.stream_read_1_bytes(t),i.extract_bits(5),this.lengthSizeMinusOne=i.extract_bits(2),this.ptl_present_flag=i.extract_bits(1),this.ptl_present_flag){if(i.stream_read_2_bytes(t),this.ols_idx=i.extract_bits(9),this.num_sublayers=i.extract_bits(3),this.constant_frame_rate=i.extract_bits(2),this.chroma_format_idc=i.extract_bits(2),i.stream_read_1_bytes(t),this.bit_depth_minus8=i.extract_bits(3),i.extract_bits(5),i.stream_read_2_bytes(t),i.extract_bits(2),this.num_bytes_constraint_info=i.extract_bits(6),this.general_profile_idc=i.extract_bits(7),this.general_tier_flag=i.extract_bits(1),this.general_level_idc=t.readUint8(),i.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=i.extract_bits(1),this.ptl_multilayer_enabled_flag=i.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(o=0;o<this.num_bytes_constraint_info-1;o++){var s=i.extract_bits(6);i.stream_read_1_bytes(t);var r=i.extract_bits(2);this.general_constraint_info[o]=s<<2|r}this.general_constraint_info[this.num_bytes_constraint_info-1]=i.extract_bits(6)}else i.extract_bits(6);for(i.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,e=this.num_sublayers-2;0<=e;--e){var n=i.extract_bits(1);this.ptl_sublayer_present_mask|=n<<e}for(e=this.num_sublayers;e<=8&&1<this.num_sublayers;++e)i.extract_bits(1);for(e=this.num_sublayers-2;0<=e;--e)this.ptl_sublayer_present_mask&1<<e&&(this.sublayer_level_idc[e]=t.readUint8());if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(o=0;o<this.ptl_num_sub_profiles;o++)this.general_sub_profile_idc.push(t.readUint32());this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}this.nalu_arrays=[];for(var a=t.readUint8(),o=0;o<a;o++){var h=[];this.nalu_arrays.push(h),i.stream_read_1_bytes(t),h.completeness=i.extract_bits(1),i.extract_bits(2),h.nalu_type=i.extract_bits(5);var l=1;for(13!=h.nalu_type&&12!=h.nalu_type&&(l=t.readUint16()),e=0;e<l;e++){var d=t.readUint16();h.push({data:t.readUint8Array(d),length:d})}}}),o.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=3&e}),o.SampleEntry.prototype.isVideo=function(){return!1},o.SampleEntry.prototype.isAudio=function(){return!1},o.SampleEntry.prototype.isSubtitle=function(){return!1},o.SampleEntry.prototype.isMetadata=function(){return!1},o.SampleEntry.prototype.isHint=function(){return!1},o.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},o.SampleEntry.prototype.getWidth=function(){return""},o.SampleEntry.prototype.getHeight=function(){return""},o.SampleEntry.prototype.getChannelCount=function(){return""},o.SampleEntry.prototype.getSampleRate=function(){return""},o.SampleEntry.prototype.getSampleSize=function(){return""},o.VisualSampleEntry.prototype.isVideo=function(){return!0},o.VisualSampleEntry.prototype.getWidth=function(){return this.width},o.VisualSampleEntry.prototype.getHeight=function(){return this.height},o.AudioSampleEntry.prototype.isAudio=function(){return!0},o.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},o.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},o.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},o.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},o.MetadataSampleEntry.prototype.isMetadata=function(){return!0},o.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=null==e?e=2:e;i.length<e;)i="0"+i;return i},o.avc1SampleEntry.prototype.getCodec=o.avc2SampleEntry.prototype.getCodec=o.avc3SampleEntry.prototype.getCodec=o.avc4SampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+o.decimalToHex(this.avcC.AVCProfileIndication)+o.decimalToHex(this.avcC.profile_compatibility)+o.decimalToHex(this.avcC.AVCLevelIndication):t},o.hev1SampleEntry.prototype.getCodec=o.hvc1SampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(t+=".",this.hvcC.general_profile_space){case 0:t+="";break;case 1:t+="A";break;case 2:t+="B";break;case 3:t+="C"}t+=this.hvcC.general_profile_idc,t+=".";for(var e=this.hvcC.general_profile_compatibility,i=0,s=0;s<32&&(i|=1&e,31!=s);s++)i<<=1,e>>=1;t+=o.decimalToHex(i,0),t+=".",0===this.hvcC.general_tier_flag?t+="L":t+="H",t+=this.hvcC.general_level_idc;var r=!1,n="";for(s=5;0<=s;s--)(this.hvcC.general_constraint_indicator[s]||r)&&(n="."+o.decimalToHex(this.hvcC.general_constraint_indicator[s],0)+n,r=!0);t+=n}return t},o.vvc1SampleEntry.prototype.getCodec=o.vvi1SampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;var e="";if(this.vvcC.general_constraint_info){var i,s,r=[];for(s=0|this.vvcC.ptl_frame_only_constraint<<7|this.vvcC.ptl_multilayer_enabled<<6,l=0;l<this.vvcC.general_constraint_info.length;++l)s|=this.vvcC.general_constraint_info[l]>>2&63,r.push(s),s&&(i=l),s=this.vvcC.general_constraint_info[l]>>2&3;if(void 0===i)e=".CA";else{e=".C";for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",a=0,h=0,l=0;l<=i;++l)for(a=a<<8|r[l],h+=8;5<=h;)e+=n[a>>h-5&31],a&=(1<<(h-=5))-1;h&&(e+=n[31&(a<<=5-h)])}}t+=e}return t},o.mp4aSampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+o.decimalToHex(e)+(i?"."+i:"")}return t},o.stxtSampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},o.vp08SampleEntry.prototype.getCodec=o.vp09SampleEntry.prototype.getCodec=function(){var t=o.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;0==e&&(e="00");var i=this.vpcC.bitDepth;return 8==i&&(i="08"),t+".0"+this.vpcC.profile+"."+e+"."+i},o.av01SampleEntry.prototype.getCodec=function(){var t,e=o.SampleEntry.prototype.getCodec.call(this),i=this.av1C.seq_level_idx_0;return i<10&&(i="0"+i),2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?t=1===this.av1C.twelve_bit?"12":"10":this.av1C.seq_profile<=2&&(t=1===this.av1C.high_bitdepth?"10":"08"),e+"."+this.av1C.seq_profile+"."+i+(this.av1C.seq_tier_0?"H":"M")+"."+t},o.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>0x100000000&&(this.size+=8),"uuid"===this.type&&(this.size+=16),i.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>0x100000000?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),"uuid"===this.type&&t.writeUint8Array(this.uuid),this.size>0x100000000&&t.writeUint64(this.size)},o.FullBox.prototype.writeHeader=function(t){this.size+=4,o.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},o.Box.prototype.write=function(t){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},o.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},o.TrackReferenceTypeBox.prototype.write=function(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)},o.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},o.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},o.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},o.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},o.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},o.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},o.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},o.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},o.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},o.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},o.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},o.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},o.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},o.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},o.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},o.SampleEntry.prototype.writeHeader=function(t){this.size=8,o.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},o.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},o.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},o.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},o.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},o.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},o.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},o.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},o.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),1===this.version&&t.writeUint32(this.default_length),2<=this.version&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&0===this.default_length&&t.writeUint32(i.description_length),i.write(t)},o.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},o.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},o.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},o.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},o.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},o.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},o.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},o.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,(this.flags=0)<this.sample_sizes.length)for(e=0;e+1<this.sample_sizes.length;){if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}e++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},o.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},o.tfdtBox.prototype.write=function(t){this.version=this.baseMediaDecodeTime>0xffffffff?1:0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(t),1===this.version?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},o.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&o.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&o.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&o.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&o.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&o.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&o.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&o.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&o.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&o.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&o.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},o.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},o.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},o.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&o.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&o.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&o.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&o.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&o.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&o.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&o.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&o.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&o.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&o.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&o.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&o.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},o["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},o["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},o.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},o.cttsBox.prototype.unpack=function(t){for(var e,i=0,s=0;s<this.sample_counts.length;s++)for(e=0;e<this.sample_counts[s];e++)t[i].pts=t[i].dts+this.sample_offsets[s],i++},o.sttsBox.prototype.unpack=function(t){for(var e,i=0,s=0;s<this.sample_counts.length;s++)for(e=0;e<this.sample_counts[s];e++)t[i].dts=0===i?0:t[i-1].dts+this.sample_deltas[s],i++},o.stcoBox.prototype.unpack=function(t){for(var e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},o.stscBox.prototype.unpack=function(t){for(var e,i,s=0,r=0,n=0;n<this.first_chunk.length;n++)for(e=0;e<(n+1<this.first_chunk.length?this.first_chunk[n+1]:1/0);e++)for(r++,i=0;i<this.samples_per_chunk[n];i++){if(!t[s])return;t[s].description_index=this.sample_description_index[n],t[s].chunk_index=r,s++}},o.stszBox.prototype.unpack=function(t){for(var e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},o.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],o.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],o.boxEqualFields=function(t,e){if(t&&!e)return!1;for(var i in t)if(!(-1<o.DIFF_BOXES_PROP_NAMES.indexOf(i)||t[i]instanceof o.Box||e[i]instanceof o.Box||void 0===t[i]||void 0===e[i]||"function"==typeof t[i]||"function"==typeof e[i]||t.subBoxNames&&-1<t.subBoxNames.indexOf(i.slice(0,4))||e.subBoxNames&&-1<e.subBoxNames.indexOf(i.slice(0,4))||"data"===i||"start"===i||"size"===i||"creation_time"===i||"modification_time"===i||-1<o.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(i)||t[i]===e[i]))return!1;return!0},o.boxEqual=function(t,e){if(!o.boxEqualFields(t,e))return!1;for(var i=0;i<o.DIFF_BOXES_PROP_NAMES.length;i++){var s=o.DIFF_BOXES_PROP_NAMES[i];if(t[s]&&e[s]&&!o.boxEqual(t[s],e[s]))return!1}return!0};var h=function(){};h.prototype.parseSample=function(t){for(var e,i=new s(t.buffer),r=[];!i.isEos();)(e=o.parseOneBox(i,!1)).code===o.OK&&"vttc"===e.box.type&&r.push(e.box);return r},h.prototype.getText=function(t,e,i){function s(t,e,i){return i=i||"0",(t+="").length>=e?t:Array(e-t.length+1).join(i)+t}function r(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),r=Math.floor(t-3600*e-60*i),t=Math.floor(1e3*(t-3600*e-60*i-r));return s(e,2)+":"+s(i,2)+":"+s(r,2)+"."+s(t,3)}for(var n=this.parseSample(i),a="",o=0;o<n.length;o++){var h=n[o];a+=r(t)+" --\x3e "+r(e)+"\r\n",a+=h.payl.text}return a};var l=function(){};l.prototype.parseSample=function(t){var e,i={resources:[]},r=new s(t.data.buffer);if(t.subsamples&&0!==t.subsamples.length){if(i.documentString=r.readString(t.subsamples[0].size),1<t.subsamples.length)for(e=1;e<t.subsamples.length;e++)i.resources[e]=r.readUint8Array(t.subsamples[e].size)}else i.documentString=r.readString(t.data.length);return"undefined"!=typeof DOMParser&&(i.document=(new DOMParser).parseFromString(i.documentString,"application/xml")),i};var d=function(){};d.prototype.parseSample=function(t){return new s(t.data.buffer).readString(t.data.length)},d.prototype.parseConfig=function(t){return(t=new s(t.buffer)).readUint32(),t.readCString()},e.XMLSubtitlein4Parser=l,e.Textin4Parser=d;var p=function(t){this.stream=t||new n,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};p.prototype.setSegmentOptions=function(t,e,i){var s,r=this.getTrackById(t);r&&(s={},this.fragmentedTracks.push(s),s.id=t,s.user=e,(s.trak=r).nextSample=0,s.segmentStream=null,s.nb_samples=1e3,s.rapAlignement=!0,i&&(i.nbSamples&&(s.nb_samples=i.nbSamples),i.rapAlignement&&(s.rapAlignement=i.rapAlignement)))},p.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++)this.fragmentedTracks[i].id==t&&(e=i);-1<e&&this.fragmentedTracks.splice(e,1)},p.prototype.setExtractionOptions=function(t,e,i){var s,r=this.getTrackById(t);r&&(s={},this.extractedTracks.push(s),s.id=t,s.user=e,(s.trak=r).nextSample=0,s.nb_samples=1e3,s.samples=[],i&&i.nbSamples&&(s.nb_samples=i.nbSamples))},p.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++)this.extractedTracks[i].id==t&&(e=i);-1<e&&this.extractedTracks.splice(e,1)},p.prototype.parse=function(){var t;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(!this.processIncompleteMdat())return}else if(this.saveParsePosition&&this.saveParsePosition(),(t=o.parseOneBox(this.stream,!1)).code===o.ERR_NOT_ENOUGH_DATA){if(!this.processIncompleteBox||!this.processIncompleteBox(t))return}else{var e,s="uuid"!==(e=t.box).type?e.type:e.uuid;switch(this.boxes.push(e),s){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[s]&&i.warn("ISOFile","Duplicate Box of type: "+s+", overriding previous occurrence"),this[s]=e}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},p.prototype.checkBuffer=function(t){if(null==t)throw"Buffer must be defined and non empty";if(void 0===t.fileStart)throw"Buffer must have a fileStart property";return 0===t.byteLength?(i.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(i.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),!!this.stream.initialized()||(i.warn("ISOFile","Not ready to start parsing"),!1))},p.prototype.appendBuffer=function(t,e){var s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):s=this.nextParsePosition||0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(i.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),i.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s},p.prototype.getInfo=function(){var t,e,i,s,r,n,a={},o=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(a.hasMoov=!0,a.duration=this.moov.mvhd.duration,a.timescale=this.moov.mvhd.timescale,a.isFragmented=null!=this.moov.mvex,a.isFragmented&&this.moov.mvex.mehd&&(a.fragment_duration=this.moov.mvex.mehd.fragment_duration),a.isProgressive=this.isProgressive,a.hasIOD=null!=this.moov.iods,a.brands=[],a.brands.push(this.ftyp.major_brand),a.brands=a.brands.concat(this.ftyp.compatible_brands),a.created=new Date(o+1e3*this.moov.mvhd.creation_time),a.modified=new Date(o+1e3*this.moov.mvhd.modification_time),a.tracks=[],a.audioTracks=[],a.videoTracks=[],a.subtitleTracks=[],a.metadataTracks=[],a.hintTracks=[],a.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(n=(i=this.moov.traks[t]).mdia.minf.stbl.stsd.entries[0],s={},a.tracks.push(s),s.id=i.tkhd.track_id,s.name=i.mdia.hdlr.name,s.references=[],i.tref)for(e=0;e<i.tref.boxes.length;e++)r={},s.references.push(r),r.type=i.tref.boxes[e].type,r.track_ids=i.tref.boxes[e].track_ids;i.edts&&(s.edits=i.edts.elst.entries),s.created=new Date(o+1e3*i.tkhd.creation_time),s.modified=new Date(o+1e3*i.tkhd.modification_time),s.movie_duration=i.tkhd.duration,s.movie_timescale=a.timescale,s.layer=i.tkhd.layer,s.alternate_group=i.tkhd.alternate_group,s.volume=i.tkhd.volume,s.matrix=i.tkhd.matrix,s.track_width=i.tkhd.width/65536,s.track_height=i.tkhd.height/65536,s.timescale=i.mdia.mdhd.timescale,s.cts_shift=i.mdia.minf.stbl.cslg,s.duration=i.mdia.mdhd.duration,s.samples_duration=i.samples_duration,s.codec=n.getCodec(),s.kind=i.udta&&i.udta.kinds.length?i.udta.kinds[0]:{schemeURI:"",value:""},s.language=i.mdia.elng?i.mdia.elng.extended_language:i.mdia.mdhd.languageString,s.nb_samples=i.samples.length,s.size=i.samples_size,s.bitrate=8*s.size*s.timescale/s.samples_duration,n.isAudio()?(s.type="audio",a.audioTracks.push(s),s.audio={},s.audio.sample_rate=n.getSampleRate(),s.audio.channel_count=n.getChannelCount(),s.audio.sample_size=n.getSampleSize()):n.isVideo()?(s.type="video",a.videoTracks.push(s),s.video={},s.video.width=n.getWidth(),s.video.height=n.getHeight()):n.isSubtitle()?(s.type="subtitles",a.subtitleTracks.push(s)):n.isHint()?(s.type="metadata",a.hintTracks.push(s)):n.isMetadata()?(s.type="metadata",a.metadataTracks.push(s)):(s.type="metadata",a.otherTracks.push(s))}else a.hasMoov=!1;if(a.mime="",a.hasMoov&&a.tracks){for(a.videoTracks&&0<a.videoTracks.length?a.mime+='video/mp4; codecs="':a.audioTracks&&0<a.audioTracks.length?a.mime+='audio/mp4; codecs="':a.mime+='application/mp4; codecs="',t=0;t<a.tracks.length;t++)0!==t&&(a.mime+=","),a.mime+=a.tracks[t].codec;a.mime+='"; profiles="',a.mime+=this.ftyp.compatible_brands.join(),a.mime+='"'}return a},p.prototype.processSamples=function(t){var e;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(e=0;e<this.fragmentedTracks.length;e++)for(var s=this.fragmentedTracks[e],r=s.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){i.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+r.nextSample);var n=this.createFragment(s.id,r.nextSample,s.segmentStream);if(!n||(s.segmentStream=n,r.nextSample++,(r.nextSample%s.nb_samples==0||t||r.nextSample>=r.samples.length)&&(i.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,r.nextSample-s.nb_samples)+","+(r.nextSample-1)+"]"),i.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e])))break}if(null!==this.onSamples)for(e=0;e<this.extractedTracks.length;e++){var a=this.extractedTracks[e];for(r=a.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){i.debug("ISOFile","Exporting on track #"+a.id+" sample #"+r.nextSample);var o=this.getSample(r,r.nextSample);if(!o||(r.nextSample++,a.samples.push(o),(r.nextSample%a.nb_samples==0||r.nextSample>=r.samples.length)&&(i.debug("ISOFile","Sending samples on track #"+a.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(a.id,a.user,a.samples),a.samples=[],a!==this.extractedTracks[e])))break}}}},p.prototype.getBox=function(t){return(t=this.getBoxes(t,!0)).length?t[0]:null},p.prototype.getBoxes=function(t,e){var i=[];return p._sweep.call(this,t,i,e),i},p._sweep=function(t,e,i){for(var s in this.type&&this.type==t&&e.push(this),this.boxes){if(e.length&&i)return;p._sweep.call(this.boxes[s],t,e,i)}},p.prototype.getTrackSamplesInfo=function(t){if(t=this.getTrackById(t))return t.samples},p.prototype.getTrackSample=function(t,e){return t=this.getTrackById(t),this.getSample(t,e)},p.prototype.releaseUsedSamples=function(t,e){var s=0,r=this.getTrackById(t);r.lastValidSample||(r.lastValidSample=0);for(var n=r.lastValidSample;n<e;n++)s+=this.releaseSample(r,n);i.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),r.lastValidSample=e},p.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},p.prototype.stop=function(){this.sampleProcessingStarted=!1},p.prototype.flush=function(){i.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},p.prototype.seekTrack=function(t,e,s){var r,n,a,o,h=0,l=0;if(0===s.samples.length)return i.info("ISOFile","No sample in track, cannot seek! Using time "+i.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(r=0;r<s.samples.length;r++){if(n=s.samples[r],0===r)l=0,o=n.timescale;else if(n.cts>t*n.timescale){l=r-1;break}e&&n.is_sync&&(h=r)}for(e&&(l=h),t=s.samples[l].cts,s.nextSample=l;s.samples[l].alreadyRead===s.samples[l].size&&s.samples[l+1];)l++;return a=s.samples[l].offset+s.samples[l].alreadyRead,i.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+i.getDurationString(t,o)+" and offset: "+a),{offset:a,time:t/o}},p.prototype.seek=function(t,e){var s,r,n=this.moov,a={offset:1/0,time:1/0};if(this.moov){for(r=0;r<n.traks.length;r++)s=n.traks[r],(s=this.seekTrack(t,e,s)).offset<a.offset&&(a.offset=s.offset),s.time<a.time&&(a.time=s.time);return i.info("ISOFile","Seeking at time "+i.getDurationString(a.time,1)+" needs a buffer with a fileStart position of "+a.offset),a.offset===1/0?a={offset:this.nextParsePosition,time:0}:a.offset=this.stream.getEndFilePositionAfter(a.offset),i.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+a.offset),a}throw"Cannot seek: moov not received!"},p.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var i=this.boxes[e],s=t.boxes[e];if(!o.boxEqual(i,s))return!1;e++}return!0},e.ISOFile=p,p.prototype.lastBoxStartPosition=0,p.prototype.parsingMdat=null,p.prototype.nextParsePosition=0,p.prototype.discardMdatData=!1,p.prototype.processIncompleteBox=function(t){var e;return"mdat"===t.type?(e=new o[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):("moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer()?(this.nextParsePosition=this.stream.getEndPosition(),!0):(!t.type||this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size,!1))},p.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},p.prototype.processIncompleteMdat=function(){var t=this.parsingMdat;return this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(i.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},p.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},p.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},p.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&("mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},p.prototype.add=o.Box.prototype.add,p.prototype.addBox=o.Box.prototype.addBox,p.prototype.init=function(t){var e=t||{},t=(this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]),this.add("moov"));return t.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,0x40000000]).set("next_track_id",1),t.add("mvex"),this},p.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("flags",o.TKHD_FLAG_ENABLED|o.TKHD_FLAG_IN_MOVIE|o.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16),(t=i.add("mdia")).add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),t.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),t.add("elng").set("extended_language",e.language||"fr-FR");var r=t.add("minf");if(void 0!==o[e.type+"SampleEntry"]){var n=new o[e.type+"SampleEntry"];n.data_reference_index=1;var a,h,l,d="";for(a in o.sampleEntryCodes)for(var p=o.sampleEntryCodes[a],f=0;f<p.length;f++)if(-1<p.indexOf(e.type)){d=a;break}switch(d){case"Visual":r.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),n.set("width",e.width).set("height",e.height).set("horizresolution",4718592).set("vertresolution",4718592).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord&&(h=new o.avcCBox,l=new s(e.avcDecoderConfigRecord),h.parse(l),n.addBox(h));break;case"Audio":r.add("smhd").set("balance",e.balance||0),n.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":r.add("hmhd");break;case"Subtitle":r.add("sthd"),"stpp"===e.type&&n.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break;default:r.add("nmhd")}return e.description&&n.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(t){n.addBox(t)}),r.add("dinf").add("dref").addEntry((new o["url Box"]).set("flags",1)),(t=r.add("stbl")).add("stsd").addEntry(n),t.add("stts").set("sample_counts",[]).set("sample_deltas",[]),t.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),t.add("stco").set("chunk_offsets",[]),t.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(i),e.id}},o.Box.prototype.computeSize=function(t){(t=t||new r).endianness=r.BIG_ENDIAN,this.write(t)},p.prototype.addSample=function(t,e,i){var s=i||{},i={},t=this.getTrackById(t);if(null!==t)return i.number=t.samples.length,i.track_id=t.tkhd.track_id,i.timescale=t.mdia.mdhd.timescale,i.description_index=s.sample_description_index?s.sample_description_index-1:0,i.description=t.mdia.minf.stbl.stsd.entries[i.description_index],i.data=e,i.size=e.byteLength,i.alreadyRead=i.size,i.duration=s.duration||1,i.cts=s.cts||0,i.dts=s.dts||0,i.is_sync=s.is_sync||!1,i.is_leading=s.is_leading||0,i.depends_on=s.depends_on||0,i.is_depended_on=s.is_depended_on||0,i.has_redundancy=s.has_redundancy||0,i.degradation_priority=s.degradation_priority||0,i.offset=0,i.subsamples=s.subsamples,t.samples.push(i),t.samples_size+=i.size,t.samples_duration+=i.duration,t.first_dts||(t.first_dts=s.dts),this.processSamples(),s=this.createSingleSampleMoof(i),this.addBox(s),s.computeSize(),s.trafs[0].truns[0].data_offset=s.size+8,this.add("mdat").data=new Uint8Array(e),i},p.prototype.createSingleSampleMoof=function(t){var e=t.is_sync?0x2000000:65536,i=new o.moofBox;i.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var s=i.add("traf"),r=this.getTrackById(t.track_id);return s.add("tfhd").set("track_id",t.track_id).set("flags",o.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s.add("tfdt").set("baseMediaDecodeTime",t.dts-(r.first_dts||0)),s.add("trun").set("flags",o.TRUN_FLAGS_DATA_OFFSET|o.TRUN_FLAGS_DURATION|o.TRUN_FLAGS_SIZE|o.TRUN_FLAGS_FLAGS|o.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),i},p.prototype.lastMoofIndex=0,p.prototype.samplesDataSize=0,p.prototype.resetTables=function(){var t,e;for(this.initial_duration=this.moov.mvhd.duration,t=this.moov.mvhd.duration=0;t<this.moov.traks.length;t++){(e=this.moov.traks[t]).tkhd.duration=0,e.mdia.mdhd.duration=0,(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[],(i=e.mdia.minf.stbl.stsc).first_chunk=[],i.samples_per_chunk=[],i.sample_description_index=[],(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[],(i=e.mdia.minf.stbl.stts).sample_counts=[],i.sample_deltas=[],(i=e.mdia.minf.stbl.ctts)&&(i.sample_counts=[],i.sample_offsets=[]),i=e.mdia.minf.stbl.stss;var i=e.mdia.minf.stbl.boxes.indexOf(i);-1!=i&&(e.mdia.minf.stbl.boxes[i]=null)}},p.initSampleGroups=function(t,e,i,s,r){var n,a,o,h;function l(t,e,i){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=i,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),a=0;a<i.length;a++){for(h=i[a].grouping_type+"/"+i[a].grouping_type_parameter,o=new l(i[a].grouping_type,i[a].grouping_type_parameter,i[a]),e&&(e.sample_groups_info[h]=o),t.sample_groups_info[h]||(t.sample_groups_info[h]=o),n=0;n<s.length;n++)s[n].grouping_type===i[a].grouping_type&&(o.description=s[n],o.description.used=!0);if(r)for(n=0;n<r.length;n++)r[n].grouping_type===i[a].grouping_type&&(o.fragment_description=r[n],o.fragment_description.used=!0,o.is_fragment=!0)}if(e){if(r)for(a=0;a<r.length;a++)!r[a].used&&2<=r[a].version&&(h=r[a].grouping_type+"/0",(o=new l(r[a].grouping_type,0)).is_fragment=!0,e.sample_groups_info[h]||(e.sample_groups_info[h]=o))}else for(a=0;a<s.length;a++)!s[a].used&&2<=s[a].version&&(h=s[a].grouping_type+"/0",o=new l(s[a].grouping_type,0),t.sample_groups_info[h]||(t.sample_groups_info[h]=o))},p.setSampleGroupProperties=function(t,e,i,s){var r,n,a;for(r in e.sample_groups=[],s)e.sample_groups[r]={},e.sample_groups[r].grouping_type=s[r].grouping_type,e.sample_groups[r].grouping_type_parameter=s[r].grouping_type_parameter,i>=s[r].last_sample_in_run&&(s[r].last_sample_in_run<0&&(s[r].last_sample_in_run=0),s[r].entry_index++,s[r].entry_index<=s[r].sbgp.entries.length-1&&(s[r].last_sample_in_run+=s[r].sbgp.entries[s[r].entry_index].sample_count)),s[r].entry_index<=s[r].sbgp.entries.length-1?e.sample_groups[r].group_description_index=s[r].sbgp.entries[s[r].entry_index].group_description_index:e.sample_groups[r].group_description_index=-1,0!==e.sample_groups[r].group_description_index&&(a=s[r].fragment_description||s[r].description,0<e.sample_groups[r].group_description_index?(n=65535<e.sample_groups[r].group_description_index?(e.sample_groups[r].group_description_index>>16)-1:e.sample_groups[r].group_description_index-1,a&&0<=n&&(e.sample_groups[r].description=a.entries[n])):a&&2<=a.version&&0<a.default_group_description_index&&(e.sample_groups[r].description=a.entries[a.default_group_description_index-1]))},p.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},p.prototype.buildSampleLists=function(){for(var t,e=0;e<this.moov.traks.length;e++)t=this.moov.traks[e],this.buildTrakSampleLists(t)},p.prototype.buildTrakSampleLists=function(t){var e,i,s,r,n,a,o,h,l,d,f,u,c,_,m,g,y,b,v,x,U,S,w,E;if(t.samples=[],t.samples_duration=0,t.samples_size=0,i=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,s=t.mdia.minf.stbl.stsc,r=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,n=t.mdia.minf.stbl.stts,a=t.mdia.minf.stbl.ctts,o=t.mdia.minf.stbl.stss,h=t.mdia.minf.stbl.stsd,l=t.mdia.minf.stbl.subs,u=t.mdia.minf.stbl.stdp,d=t.mdia.minf.stbl.sbgps,f=t.mdia.minf.stbl.sgpds,U=x=v=b=-1,E=w=S=0,p.initSampleGroups(t,null,d,f),void 0!==r){for(e=0;e<r.sample_sizes.length;e++){var B={};B.number=e,B.track_id=t.tkhd.track_id,B.timescale=t.mdia.mdhd.timescale,B.alreadyRead=0,(t.samples[e]=B).size=r.sample_sizes[e],t.samples_size+=B.size,0===e?(_=1,c=0,B.chunk_index=_,B.chunk_run_index=c,y=s.samples_per_chunk[c],g=0,m=c+1<s.first_chunk.length?s.first_chunk[c+1]-1:1/0):e<y?(B.chunk_index=_,B.chunk_run_index=c):(_++,g=0,(B.chunk_index=_)<=m||(m=++c+1<s.first_chunk.length?s.first_chunk[c+1]-1:1/0),B.chunk_run_index=c,y+=s.samples_per_chunk[c]),B.description_index=s.sample_description_index[B.chunk_run_index]-1,B.description=h.entries[B.description_index],B.offset=i.chunk_offsets[B.chunk_index-1]+g,g+=B.size,b<e&&(v++,b<0&&(b=0),b+=n.sample_counts[v]),0<e?(t.samples[e-1].duration=n.sample_deltas[v],t.samples_duration+=t.samples[e-1].duration,B.dts=t.samples[e-1].dts+t.samples[e-1].duration):B.dts=0,a?(x<=e&&(U++,x<0&&(x=0),x+=a.sample_counts[U]),B.cts=t.samples[e].dts+a.sample_offsets[U]):B.cts=B.dts,o?(e==o.sample_numbers[S]-1?(B.is_sync=!0,S++):(B.is_sync=!1,B.degradation_priority=0),l&&l.entries[w].sample_delta+E==e+1&&(B.subsamples=l.entries[w].subsamples,E+=l.entries[w].sample_delta,w++)):B.is_sync=!0,p.process_sdtp(t.mdia.minf.stbl.sdtp,B,B.number),B.degradation_priority=u?u.priority[e]:0,l&&l.entries[w].sample_delta+E==e&&(B.subsamples=l.entries[w].subsamples,E+=l.entries[w].sample_delta),(0<d.length||0<f.length)&&p.setSampleGroupProperties(t,B,e,t.sample_groups_info)}0<e&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},p.prototype.updateSampleLists=function(){var t,e,i,s,r,n,a,h,l,d,f;if(void 0!==this.moov){for(;this.lastMoofIndex<this.moofs.length;)if(a=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==a.type)for(t=0;t<a.trafs.length;t++){for(h=a.trafs[t],l=this.getTrackById(h.tfhd.track_id),d=this.getTrexById(h.tfhd.track_id),e=h.tfhd.flags&o.TFHD_FLAG_SAMPLE_DESC?h.tfhd.default_sample_description_index:d?d.default_sample_description_index:1,i=h.tfhd.flags&o.TFHD_FLAG_SAMPLE_DUR?h.tfhd.default_sample_duration:d?d.default_sample_duration:0,s=h.tfhd.flags&o.TFHD_FLAG_SAMPLE_SIZE?h.tfhd.default_sample_size:d?d.default_sample_size:0,r=h.tfhd.flags&o.TFHD_FLAG_SAMPLE_FLAGS?h.tfhd.default_sample_flags:d?d.default_sample_flags:0,(h.sample_number=0)<h.sbgps.length&&p.initSampleGroups(l,h,h.sbgps,l.mdia.minf.stbl.sgpds,h.sgpds),v=0;v<h.truns.length;v++)for(var u=h.truns[v],c=0;c<u.sample_count;c++){(f={}).moof_number=this.lastMoofIndex,f.number_in_traf=h.sample_number,h.sample_number++,f.number=l.samples.length,h.first_sample_index=l.samples.length,l.samples.push(f),f.track_id=l.tkhd.track_id,f.timescale=l.mdia.mdhd.timescale,f.description_index=e-1,f.description=l.mdia.minf.stbl.stsd.entries[f.description_index],f.size=s,u.flags&o.TRUN_FLAGS_SIZE&&(f.size=u.sample_size[c]),l.samples_size+=f.size,f.duration=i,u.flags&o.TRUN_FLAGS_DURATION&&(f.duration=u.sample_duration[c]),l.samples_duration+=f.duration,l.first_traf_merged||0<c?f.dts=l.samples[l.samples.length-2].dts+l.samples[l.samples.length-2].duration:(h.tfdt?f.dts=h.tfdt.baseMediaDecodeTime:f.dts=0,l.first_traf_merged=!0),f.cts=f.dts,u.flags&o.TRUN_FLAGS_CTS_OFFSET&&(f.cts=f.dts+u.sample_composition_time_offset[c]),y=r,u.flags&o.TRUN_FLAGS_FLAGS?y=u.sample_flags[c]:0===c&&u.flags&o.TRUN_FLAGS_FIRST_FLAG&&(y=u.first_sample_flags),f.is_sync=!(y>>16&1),f.is_leading=y>>26&3,f.depends_on=y>>24&3,f.is_depended_on=y>>22&3,f.has_redundancy=y>>20&3,f.degradation_priority=65535&y;var _=!!(h.tfhd.flags&o.TFHD_FLAG_BASE_DATA_OFFSET),m=!!(h.tfhd.flags&o.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),g=!!(u.flags&o.TRUN_FLAGS_DATA_OFFSET),y=_?h.tfhd.base_data_offset:m||0===v?a.start:n;f.offset=0===v&&0===c?g?y+u.data_offset:y:n,n=f.offset+f.size,(0<h.sbgps.length||0<h.sgpds.length||0<l.mdia.minf.stbl.sbgps.length||0<l.mdia.minf.stbl.sgpds.length)&&p.setSampleGroupProperties(l,f,f.number_in_traf,h.sample_groups_info)}if(h.subs){l.has_fragment_subsamples=!0;for(var b=h.first_sample_index,v=0;v<h.subs.entries.length;v++)b+=h.subs.entries[v].sample_delta,(f=l.samples[b-1]).subsamples=h.subs.entries[v].subsamples}}}},p.prototype.getSample=function(t,e){var s,n=t.samples[e];if(!this.moov)return null;if(n.data){if(n.alreadyRead==n.size)return n}else n.data=new Uint8Array(n.size),n.alreadyRead=0,this.samplesDataSize+=n.size,i.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+n.size+" (total: "+this.samplesDataSize+")");for(;;){var a=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(!(-1<a))return null;if(a=(s=this.stream.buffers[a]).byteLength-(n.offset+n.alreadyRead-s.fileStart),n.size-n.alreadyRead<=a)return i.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+(n.size-n.alreadyRead)+" full size: "+n.size+")"),r.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,n.size-n.alreadyRead),s.usedBytes+=n.size-n.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead=n.size,n;if(0==a)return null;i.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+a+" full size: "+n.size+")"),r.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,a),n.alreadyRead+=a,s.usedBytes+=a,this.stream.logBufferLevel()}},p.prototype.releaseSample=function(t,e){return(e=t.samples[e]).data?(this.samplesDataSize-=e.size,e.data=null,e.alreadyRead=0,e.size):0},p.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},p.prototype.getCodecs=function(){for(var t="",e=0;e<this.moov.traks.length;e++)0<e&&(t+=","),t+=this.moov.traks[e].mdia.minf.stbl.stsd.entries[0].getCodec();return t},p.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},p.prototype.getTrackById=function(t){if(void 0===this.moov)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},p.prototype.items=[],p.prototype.itemsDataSize=0,p.prototype.flattenItemInfo=function(){var t=this.items,e=this.meta;if(null!=e&&void 0!==e.hdlr&&void 0!==e.iinf){for(l=0;l<e.iinf.item_infos.length;l++)(r={}).id=e.iinf.item_infos[l].item_ID,(t[r.id]=r).ref_to=[],r.name=e.iinf.item_infos[l].item_name,0<e.iinf.item_infos[l].protection_index&&(r.protection=e.ipro.protections[e.iinf.item_infos[l].protection_index-1]),e.iinf.item_infos[l].item_type?r.type=e.iinf.item_infos[l].item_type:r.type="mime",r.content_type=e.iinf.item_infos[l].content_type,r.content_encoding=e.iinf.item_infos[l].content_encoding;if(e.iloc)for(l=0;l<e.iloc.items.length;l++){var s=e.iloc.items[l],r=t[s.item_ID];switch(0!==s.data_reference_index&&(i.warn("Item storage with reference to other files: not supported"),r.source=e.dinf.boxes[s.data_reference_index-1]),s.construction_method){case 0:break;case 1:case 2:i.warn("Item storage with construction_method : not supported")}for(r.extents=[],a=r.size=0;a<s.extents.length;a++)r.extents[a]={},r.extents[a].offset=s.extents[a].extent_offset+s.base_offset,r.extents[a].length=s.extents[a].extent_length,r.extents[a].alreadyRead=0,r.size+=r.extents[a].length}if(e.pitm&&(t[e.pitm.item_id].primary=!0),e.iref)for(l=0;l<e.iref.references.length;l++)for(var n=e.iref.references[l],a=0;a<n.references.length;a++)t[n.from_item_ID].ref_to.push({type:n.type,id:n.references[a]});if(e.iprp)for(var o=0;o<e.iprp.ipmas.length;o++)for(var h=e.iprp.ipmas[o],l=0;l<h.associations.length;l++){var d=h.associations[l];for(void 0===(r=t[d.id]).properties&&(r.properties={},r.properties.boxes=[]),a=0;a<d.props.length;a++){var p=d.props[a];0<p.property_index&&p.property_index-1<e.iprp.ipco.boxes.length&&(p=e.iprp.ipco.boxes[p.property_index-1],r.properties[p.type]=p,r.properties.boxes.push(p))}}}},p.prototype.getItem=function(t){var e,s;if(!this.meta)return null;if(!(s=this.items[t]).data&&s.size)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.itemsDataSize+=s.size,i.debug("ISOFile","Allocating item #"+t+" of size "+s.size+" (total: "+this.itemsDataSize+")");else if(s.alreadyRead===s.size)return s;for(var n=0;n<s.extents.length;n++){var a=s.extents[n];if(a.alreadyRead!==a.length){var o=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(!(-1<o))return null;if(o=(e=this.stream.buffers[o]).byteLength-(a.offset+a.alreadyRead-e.fileStart),!(a.length-a.alreadyRead<=o))return i.debug("ISOFile","Getting item #"+t+" extent #"+n+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+o+" full extent size: "+a.length+" full item size: "+s.size+")"),r.memcpy(s.data.buffer,s.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,o),a.alreadyRead+=o,s.alreadyRead+=o,e.usedBytes+=o,this.stream.logBufferLevel(),null;i.debug("ISOFile","Getting item #"+t+" extent #"+n+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+(a.length-a.alreadyRead)+" full extent size: "+a.length+" full item size: "+s.size+")"),r.memcpy(s.data.buffer,s.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,a.length-a.alreadyRead),e.usedBytes+=a.length-a.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead+=a.length-a.alreadyRead,a.alreadyRead=a.length}}return s.alreadyRead===s.size?s:null},p.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null;for(var i=e.alreadyRead=0;i<e.extents.length;i++)e.extents[i].alreadyRead=0;return e.size}return 0},p.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},p.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return -1},p.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},p.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},p.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},i=null;return null==(i=e.itemId?this.getItem(e.itemId):this.getPrimaryItem())?null:((t=new p).discardMdatData=!1,e={type:i.type,description_boxes:i.properties.boxes},i.properties.ispe&&(e.width=i.properties.ispe.image_width,e.height=i.properties.ispe.image_height),(e=t.addTrack(e))?(t.addSample(e,i.data),t):null)},p.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},p.prototype.createFragment=function(t,e,s){var n=this.getTrackById(t),t=this.getSample(n,e);return null==t?(t=n.samples[e],this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=n.samples[e].offset+t.alreadyRead,null):((e=s||new r).endianness=r.BIG_ENDIAN,(s=this.createSingleSampleMoof(t)).write(e),s.trafs[0].truns[0].data_offset=s.size+8,i.debug("MP4Box","Adjusting data_offset with new value "+s.trafs[0].truns[0].data_offset),e.adjustUint32(s.trafs[0].truns[0].data_offset_position,s.trafs[0].truns[0].data_offset),(s=new o.mdatBox).data=t.data,s.write(e),e)},p.writeInitializationSegment=function(t,e,s,n){i.debug("ISOFile","Generating initialization segment");var a,o=new r;o.endianness=r.BIG_ENDIAN,t.write(o);var h=e.add("mvex");for(s&&h.add("mehd").set("fragment_duration",s),a=0;a<e.traks.length;a++)h.add("trex").set("track_id",e.traks[a].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",n).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(o),o.buffer},p.prototype.save=function(t){var e=new r;e.endianness=r.BIG_ENDIAN,this.write(e),e.save(t)},p.prototype.getBuffer=function(){var t=new r;return t.endianness=r.BIG_ENDIAN,this.write(t),t.buffer},p.prototype.initializeSegmentation=function(){var t,e,s,r;for(null===this.onSegment&&i.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var n=new o.moovBox;n.mvhd=this.moov.mvhd,n.boxes.push(n.mvhd),s=this.getTrackById(this.fragmentedTracks[t].id),n.boxes.push(s),n.traks.push(s),(r={}).id=s.tkhd.track_id,r.user=this.fragmentedTracks[t].user,r.buffer=p.writeInitializationSegment(this.ftyp,n,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,0<this.moov.traks[t].samples.length?this.moov.traks[t].samples[0].duration:0),e.push(r)}return e},o.Box.prototype.printHeader=function(t){this.size+=8,this.size>0x100000000&&(this.size+=8),"uuid"===this.type&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},o.FullBox.prototype.printHeader=function(t){this.size+=4,o.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},o.Box.prototype.print=function(t){this.printHeader(t)},o.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e,i=0;i<this.boxes.length;i++)this.boxes[i]&&(e=t.indent,t.indent+=" ",this.boxes[i].print(t),t.indent=e)},p.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},o.mvhdBox.prototype.print=function(t){o.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},o.tkhdBox.prototype.print=function(t){o.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)},e.createFile=function(t,e){return t=void 0===t||t,(e=new p(e)).discardMdatData=!t,e}},1674:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>k});var s=i(5155),r=i(2115);function n(t,e,i){if(!e.has(t))throw TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function a(t,e){var i=n(t,e,"get");return i.get?i.get.call(t):i.value}function o(t,e){if(e.has(t))throw TypeError("Cannot initialize the same private elements twice on an object")}function h(t,e,i){o(t,e),e.set(t,i)}function l(t,e,i){var s=n(t,e,"set");return!function(t,e,i){if(e.set)e.set.call(t,i);else{if(!e.writable)throw TypeError("attempted to set read only private field");e.value=i}}(t,s,i),i}function d(t,e,i){if(!e.has(t))throw TypeError("attempted to get private field on non-instance");return i}function p(t,e){o(t,e),e.add(t)}var f=i(1758),u=new WeakMap,c=new WeakMap,_=new WeakMap;class m{write(t){let e=new ArrayBuffer(t.byteLength);new Uint8Array(e).set(t),e.fileStart=a(this,_),l(this,_,a(this,_)+e.byteLength),a(this,u).call(this,"fetch",(a(this,_)/1048576).toFixed(1)+" MiB"),a(this,c).appendBuffer(e)}close(){a(this,u).call(this,"fetch","Done"),a(this,c).flush()}constructor(t,e){h(this,u,{writable:!0,value:void 0}),h(this,c,{writable:!0,value:void 0}),h(this,_,{writable:!0,value:void 0}),l(this,u,null),l(this,c,null),l(this,_,0),l(this,c,t),l(this,u,e)}}var g=new WeakMap,y=new WeakMap,b=new WeakMap,v=new WeakMap,x=new WeakSet,U=new WeakSet,S=new WeakSet;class w{constructor(t,{onConfig:e,onChunk:i,setStatus:s}){p(this,x),p(this,U),p(this,S),h(this,g,{writable:!0,value:void 0}),h(this,y,{writable:!0,value:void 0}),h(this,b,{writable:!0,value:void 0}),h(this,v,{writable:!0,value:void 0}),l(this,g,null),l(this,y,null),l(this,b,null),l(this,v,null),l(this,g,e),l(this,y,i),l(this,b,s),l(this,v,f.createFile()),a(this,v).onError=t=>s("demux",t),a(this,v).onReady=d(this,U,B).bind(this),a(this,v).onSamples=d(this,S,A).bind(this);let r=new m(a(this,v),s);fetch(t).then(t=>{t.body.pipeTo(new WritableStream(r,{highWaterMark:2}))})}}function E(t){for(let e of a(this,v).getTrackById(t.id).mdia.minf.stbl.stsd.entries){let t=e.avcC||e.hvcC||e.vpcC||e.av1C;if(t){let e=new f.DataStream(void 0,0,f.DataStream.BIG_ENDIAN);return t.write(e),new Uint8Array(e.buffer,8)}}throw Error("avcC, hvcC, vpcC, or av1C box not found")}function B(t){a(this,b).call(this,"demux","Ready");let e=t.videoTracks[0];a(this,g).call(this,{codec:e.codec.startsWith("vp08")?"vp8":e.codec,codedHeight:e.video.height,codedWidth:e.video.width,description:d(this,x,E).call(this,e)}),a(this,v).setExtractionOptions(e.id),a(this,v).start()}function A(t,e,i){for(let t of i)a(this,y).call(this,new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:1e6*t.cts/t.timescale,duration:1e6*t.duration/t.timescale,data:t.data}))}class T{getFrame(t){var e;if(!(t<0)&&!(t>=this.frames.length))return null===(e=this.frames[t])||void 0===e?void 0:e.frame}length(){return this.frames.length}close(){this.frames=[]}onVideoFrame(t){this.canvas.width=this.width,this.canvas.height=this.height;let e=this.canvas.getContext("2d",{willReadFrequently:!0});if(null==e)return;e.drawImage(t,0,0,this.width,this.height),t.close();let i=new Image(this.width,this.height);i.src=this.canvas.toDataURL("image/png");let s={frame:i,time:t.timestamp};this.frames.push(s),this.frames.sort((t,e)=>t.time-e.time),this.props.onVideoFrame()}constructor(t){this.props=t,this.frames=[],this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.decoder=new VideoDecoder({output:t=>{this.onVideoFrame(t),null!=this.timer&&clearTimeout(this.timer),this.timer=setTimeout(async()=>{"closed"!=this.decoder.state&&(await this.decoder.flush(),this.decoder.close(),this.props.onVideoLoaded())},500)},error:t=>{console.error(t)}}),this.demuxer=new w(t.filename,{onConfig:t=>{this.width=t.codedWidth,this.height=t.codedHeight,console.log("decode ".concat(t.codec)),this.decoder.configure(t)},onChunk:t=>{this.decoder.decode(t)},setStatus:t=>{console.log("setStatus ".concat(t))}}),this.timer=0}}class z{check(){if(this.points.length<2)return!1;for(let t=1;t<this.points.length;t++){let e=this.points[t-1],i=this.points[t];if(i.x===e.x&&i.y===e.y)return this.points.splice(t,1),this.check()}return!0}drawArrowHead(t,e,i,s,r){let n=e.x-i.x,a=Math.atan2(e.y-i.y,n);for(let i=-1;i<=1;i+=2){t.beginPath(),t.moveTo(e.x*r,e.y*r);let n=s*Math.cos(a+i*Math.PI*.8),o=s*Math.sin(a+i*Math.PI*.8);t.lineTo((e.x+n)*r,(e.y+o)*r),t.stroke()}}draw(t,e,i,s){if(this.points.length<2){console.error("no points in slider");return}if(t.save(),"none"!==this.color[e]&&this.lineWidth[e]>0){t.strokeStyle=this.color[e],t.lineWidth=this.lineWidth[e]*s,t.lineCap="round",t.globalAlpha=i;let r=this.points[0];t.beginPath(),t.moveTo(r.x*s,r.y*s);for(let e=1;e<this.points.length;e++){let i=this.points[e];t.lineTo(i.x*s,i.y*s),r=i}t.stroke(),this.drawArrowHead(t,this.points[0],this.points[1],3*this.lineWidth[e],s),this.drawArrowHead(t,this.points[this.points.length-1],this.points[this.points.length-2],3*this.lineWidth[e],s)}if(this.debug){for(let e=0;e<this.points.length;e++){let i=this.points[e];if(t.strokeStyle="#ccccff",t.beginPath(),t.moveTo(i.x*s,i.y*s),t.lineTo((i.x+50*i.bx)*s,(i.y+50*i.by)*s),t.lineTo((i.x-50*i.bx)*s,(i.y-50*i.by)*s),t.stroke(),t.restore(),e<this.points.length-1){t.strokeStyle=i.selected?"#ff2200":"#ffcccc";let r=this.points[e+1];t.beginPath(),t.moveTo(i.x*s,i.y*s),t.lineTo(r.x*s,r.y*s),t.stroke(),t.restore()}}t.strokeStyle="#ff2200",t.strokeRect(this.thumbX-3,this.thumbY-3,6,6)}t.restore()}normPerpendicular(t,e,i,s){let r=t-i,n=e-s,a=Math.hypot(r,n);return{bx:n/a,by:-r/a}}calcBisectors(){this.points.forEach((t,e)=>{if(0===e){let i=this.points[e+1],s=this.normPerpendicular(t.x,t.y,i.x,i.y);t.bx=s.bx,t.by=s.by}else if(e===this.points.length-1){let i=this.points[e-1],s=this.normPerpendicular(i.x,i.y,t.x,t.y);t.bx=s.bx,t.by=s.by}else{let i=this.points[e+1],s=this.points[e-1],r=(Math.PI+Math.atan2(t.y-s.y,t.x-s.x)+Math.atan2(i.y-t.y,i.x-t.x))/2;t.bx=Math.cos(r),t.by=Math.sin(r)}})}side(t,e,i,s,r,n){return n*(t-i)-r*(e-s)}findSection(t,e,i){let s,r,n;console.assert(this.points.length>=2);let a=this.range;for(let o=0;o<this.points.length-1;o++)if((r=this.points[o]).selected=!1,n=this.points[o+1],this.side(t,e,r.x,r.y,r.bx,r.by)*this.side(n.x,n.y,r.x,r.y,r.bx,r.by)>0&&this.side(t,e,n.x,n.y,n.bx,n.by)*this.side(r.x,r.y,n.x,n.y,n.bx,n.by)>0){let h=Math.atan2(n.y-r.y,n.x-r.x),l=Math.atan2(e-r.y,t-r.x),d=Math.abs(Math.hypot(t-r.x,e-r.y)*Math.sin(l-h));(i||d<=this.range)&&(null==s||d<a)&&(a=d,r.selected=!0,s=o)}if(r=this.points[0],n=this.points[1],this.side(t,e,r.x,r.y,r.bx,r.by)*this.side(n.x,n.y,r.x,r.y,r.bx,r.by)<=0){let n=Math.hypot(t-r.x,e-r.y);(i||n<=this.range)&&(null==s||n<a)&&(a=n,s=-1)}if(r=this.points[this.points.length-2],n=this.points[this.points.length-1],this.side(t,e,n.x,n.y,n.bx,n.by)*this.side(r.x,r.y,n.x,n.y,n.bx,n.by)<=0){let r=Math.hypot(t-n.x,e-n.y);(i||r<=this.range)&&(null==s||r<a)&&(a=r,s=this.points.length-1)}return{ind:s,dist:a}}getS(t,e,i,s,r,n,a,o){let h=o*i-a*s;return console.assert(0!=h),Math.abs((o*r-a*n-o*t+a*e)/h)}setThumb(t,e,i){return this.thumbX=t,this.thumbY=e,{tx:t,ty:e,v:i}}getThumb(t,e,i){if(console.assert(this.points.length>=2),i<0){let t=this.points[0];return this.setThumb(t.x,t.y,t.v)}if(i>=this.points.length-1){let t=this.points[i];return this.setThumb(t.x,t.y,t.v)}let s=this.points[i],r=this.points[i+1],n=r.x-s.x,a=r.y-s.y,o=Math.hypot(n,a);console.assert(o>0),n/=o,a/=o;let h=this.getS(t,e,n,a,s.x,s.y,s.bx,s.by),l=this.getS(t,e,n,a,r.x,r.y,r.bx,r.by),d=h+l,p=(s.x*l+r.x*h)/d,f=(s.y*l+r.y*h)/d,u=(s.v*l+r.v*h)/d;return this.setThumb(p,f,u)}constructor(t){this.points=[],this.range=999999,this.color=["red","red","none"],this.lineWidth=[1,1,0],this.active=!0,this.arrow="",this.curLine=-1,this.thumbX=0,this.thumbY=0,this.debug=null!=t&&t}}class I{prepare(){for(let t of this.sliders){if(!t.check())return!1;t.calcBisectors()}return!0}draw(t,e,i){for(let s of this.sliders){let r=this.pressed?2:s===this.curSlider?1:0;s.draw(t,r,e,i)}}async load(t){let e=await fetch(t);for(let t of(await e.json())){let e=new z(this.props.debug);for(let i of(e.range=t.range,e.arrow=t.arrow,e.lineWidth=t.width,e.color=t.color,t.points)){let t={x:i.x,y:i.y,v:i.v,bx:0,by:0,selected:!1};e.points.push(t)}this.sliders.push(e)}return this.prepare(),!0}onMouseOver(t,e){let i,s;this.sliders.forEach(r=>{let{ind:n,dist:a}=r.findSection(t,e,!1);null!=n&&(null==s||a<s)&&(i=r,s=a)}),this.curSlider=i}onMouseDrag(t,e){if(null==this.curSlider)return;let{ind:i}=this.curSlider.findSection(t,e,!0);if(null==i)return;let{v:s}=this.curSlider.getThumb(t,e,i);this.curValue=s,this.props.onDrag(s)}onMouseDown(t,e){this.pressed=!0,this.onMouseOver(t,e),this.onMouseDrag(t,e)}onMouseUp(){this.curSlider=void 0,this.pressed=!1}constructor(t){this.props=t,this.sliders=[],this.pressed=!1,this.load(t.filename)}}let C=function(t){var e,i,n,a,o,h;let l=null!==(n=t.width)&&void 0!==n?n:100,d=null!==(a=t.height)&&void 0!==a?a:100,p=(0,r.useRef)(),f=(0,r.useRef)(),u=(0,r.useRef)(null),c=null===(e=u.current)||void 0===e?void 0:e.getBoundingClientRect(),_=(null!==(o=null==c?void 0:c.width)&&void 0!==o?o:l)/(null!==(h=null===(i=p.current)||void 0===i?void 0:i.width)&&void 0!==h?h:l),[m,g]=(0,r.useState)(-1),[y,b]=(0,r.useState)(!0),v=(0,r.useRef)(!1),[x,U]=(0,r.useState)({counter:0,alpha:0}),S=(0,r.useCallback)(()=>{U({counter:(x.counter+1)%10,alpha:Math.sin(Math.PI*x.counter/10)})},[x]);function w(){if(m<0||null==p.current||null==u.current)return;let t=p.current.getFrame(m);if(null==t){console.log("retry drawing ".concat(m)),setTimeout(w,100);return}let e=u.current.getContext("2d");null==e||(e.drawImage(t,0,0,p.current.width,p.current.height,0,0,l,d),null==f.current||y||f.current.draw(e,x.alpha,_))}function E(){g(0)}function B(){b(!1)}function A(){v.current=!1,null==f.current||y||(f.current.onMouseUp(),w())}function z(){v.current=!0}function C(){v.current=!1}return!function(t,e){let i=(0,r.useRef)();(0,r.useEffect)(()=>{i.current=t}),(0,r.useEffect)(()=>{let t=setInterval(()=>{null!=i.current&&i.current()},100);return()=>clearInterval(t)},[100])}(()=>{S()},0),(0,r.useEffect)(()=>{if(null==p.current&&(p.current=new T({filename:t.filename,onVideoFrame:E,onVideoLoaded:B})),null==f.current){var e;f.current=new I({filename:t.filename.slice(0,-4)+".json",onDrag:t=>{g(Math.round(t))},debug:null!==(e=t.debug)&&void 0!==e&&e})}function i(t){v.current&&t.cancelable&&t.preventDefault()}return window.addEventListener("touchstart",i,{passive:!1}),window.addEventListener("touchmove",i,{passive:!1}),window.addEventListener("touchend",i,{passive:!1}),window.addEventListener("touchcancel",i,{passive:!1}),()=>{null!=p.current&&(p.current.close(),p.current=void 0),null!=f.current&&(f.current=void 0),window.removeEventListener("touchstart",i),window.removeEventListener("touchmove",i),window.removeEventListener("touchend",i),window.removeEventListener("touchcancel",i)}},[t.debug,t.filename]),(0,r.useEffect)(()=>{null!=u.current&&null!=p.current&&w()},[m,y,x]),(0,s.jsxs)("div",{style:{...t.style,width:l,height:d,position:"relative"},className:t.className,children:[(0,s.jsx)("canvas",{ref:u,width:l,height:d,className:"bg-blue-200 border-none",style:{width:l,height:d},onMouseMove:function(t){null==f.current||y||(0===t.nativeEvent.buttons?f.current.onMouseOver(t.nativeEvent.offsetX/_,t.nativeEvent.offsetY/_):f.current.onMouseDrag(t.nativeEvent.offsetX/_,t.nativeEvent.offsetY/_),w())},onMouseDown:function(t){null==f.current||y||(f.current.onMouseDown(t.nativeEvent.offsetX/_,t.nativeEvent.offsetY/_),w())},onMouseUp:function(){null==f.current||y||(f.current.onMouseUp(),w())},onTouchStart:function(t){v.current=!0,null==u.current||null==f.current||y||null==c||(t.targetTouches.length>=1&&f.current.onMouseDown((t.targetTouches[0].clientX-c.left)/_,(t.targetTouches[0].clientY-c.top)/_),w())},onTouchMove:function(t){null==u.current||null==f.current||y||null==c||(t.targetTouches.length>=1&&f.current.onMouseDrag((t.targetTouches[0].clientX-c.left)/_,(t.targetTouches[0].clientY-c.top)/_),w())},onTouchEnd:A,onTouchCancel:function(){A()}}),y&&(0,s.jsx)("div",{className:"absolute left-0 top-0 w-full h-full bg-white bg-opacity-50 p-4",onTouchStart:z,onTouchMove:z,onTouchEnd:C,onTouchCancel:C,children:"loading ..."})]})};function k(){let[t,e]=(0,r.useState)(),i=async()=>{let t=new URL(document.URL).searchParams.get("vid"),i=await fetch("v/".concat(t,"/fileinfo.json")),s=await i.json(),r=s.localFilename,n=s.width,a=s.height;if(null==r||r.includes("/")||r.includes("\\"))e({fileName:"",width:0,height:0});else{let i=window.innerWidth,s=window.innerHeight,o=i/n,h=s/a,l=o<h?o:h;e({fileName:"v/".concat(t,"/").concat(r),width:n*l,height:a*l})}};return(0,r.useEffect)(()=>{i()},[]),(0,s.jsx)("main",{className:"flex flex-col items-center justify-between w-screen h-screen bg-black",children:(0,s.jsx)("div",{className:"relative",children:null!=t?t.width>0?(0,s.jsx)(C,{className:"absolute left-0 top-0",filename:t.fileName,width:t.width,height:t.height}):(0,s.jsx)("span",{children:"Error"}):(0,s.jsx)("span",{children:"loading..."})})})}}},t=>{var e=e=>t(t.s=e);t.O(0,[441,517,358],()=>e(5457)),_N_E=t.O()}]);